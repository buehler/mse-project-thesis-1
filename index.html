<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Christoph Bühler" />
  <meta name="keywords" content="Authentication, Distributed, Trust Zone, Microservices, Kubernetes" />
  <title>Distributed Authentication Mesh</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Distributed Authentication Mesh</h1>
<p class="subtitle">A Concept for Declarative Adhoc Conversion of Credentials</p>
<p class="author">Christoph Bühler</p>
<p class="date"><p>Spring Semester 2021<br />
University of Applied Science of Eastern Switzerland (OST)</p></p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#sec:introduction">Introduction</a></li>
<li><a href="#sec:definitions">Definitions and Clarification of the Scope</a>
<ul>
<li><a href="#scope-of-the-project">Scope of the Project</a></li>
<li><a href="#kubernetes-as-an-orchestration-engine">Kubernetes as an Orchestration Engine</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#terminology">Terminology</a></li>
</ul></li>
<li><a href="#sec:kubernetes_operator">The Operator Pattern</a></li>
<li><a href="#sec:kubernetes_sidecar">The Sidecar Pattern</a></li>
<li><a href="#sec:service_mesh">Controlling the Data with a Service Mesh</a></li>
<li><a href="#authentication-authorization-and-security">Authentication, Authorization, and Security</a>
<ul>
<li><a href="#sec:basic_auth">Basic Authentication (RFC7617)</a></li>
<li><a href="#sec:auth_oidc">OpenID Connect (OIDC)</a></li>
<li><a href="#sec:zero-trust">Zero Trust Environment</a></li>
</ul></li>
</ul></li>
<li><a href="#sec:state_of_the_art">State of the Art and the Practice</a>
<ul>
<li><a href="#accessing-legacy-systems-from-modern-systems">Accessing Legacy Systems from Modern Systems</a></li>
<li><a href="#external-authentication-and-identity-transport">External Authentication and Identity Transport</a></li>
<li><a href="#sec:deficiencies">Missing Dynamic Credential Transformation</a></li>
</ul></li>
<li><a href="#sec:solution">Distributed Authentication Mesh</a>
<ul>
<li><a href="#definition">Definition</a></li>
<li><a href="#goals-and-non-goals-of-the-project">Goals and Non-Goals of the Project</a></li>
<li><a href="#differentiation-from-other-technologies">Differentiation from other Technologies</a>
<ul>
<li><a href="#sec:saml">Security Assertion Markup Language</a></li>
<li><a href="#sec:ws-deathstar">WS-*</a></li>
</ul></li>
<li><a href="#use-case-of-dynamic-credential-transformation">Use Case of Dynamic Credential Transformation</a></li>
<li><a href="#architecture-of-the-solution">Architecture of the Solution</a>
<ul>
<li><a href="#brief-description">Brief Description</a></li>
<li><a href="#sec:abstract_architecture">Abstract and Conceptional Architecture</a></li>
<li><a href="#sec:specific_architecture">Platform-Specific Example in Kubernetes</a></li>
</ul></li>
<li><a href="#securing-the-communication-between-applications">Securing the Communication between Applications</a></li>
<li><a href="#sec:poc">Implementation Proof of Concept (POC)</a>
<ul>
<li><a href="#sec:install_poc">Installation of the POC</a></li>
<li><a href="#case-study-for-the-poc">Case Study for the POC</a></li>
<li><a href="#automation-engine-for-applications">Automation Engine for Applications</a></li>
<li><a href="#network-and-routing-proxy-for-communication">Network and Routing Proxy for Communication</a></li>
<li><a href="#sec:poc_translator">Translator</a></li>
</ul></li>
</ul></li>
<li><a href="#sec:evaluation">Evaluation</a>
<ul>
<li><a href="#architecture-against-requirements">Architecture against Requirements</a>
<ul>
<li><a href="#nfr-1-improve-security">NFR 1: Improve Security</a></li>
<li><a href="#nfr-2-secure-implementation">NFR 2: Secure implementation</a></li>
<li><a href="#nfr-3-generic-usage">NFR 3: Generic Usage</a></li>
<li><a href="#nfr-4-performance-impact">NFR 4: Performance Impact</a></li>
<li><a href="#nfr-5-modularity">NFR 5: Modularity</a></li>
<li><a href="#nfr-6-interoperability">NFR 6: Interoperability</a></li>
<li><a href="#nfr-7-scalability">NFR 7: Scalability</a></li>
<li><a href="#nfr-8-separation-of-concerns">NFR 8: Separation of Concerns</a></li>
<li><a href="#nfr-9-no-data-transfer">NFR 9: No Data-Transfer</a></li>
<li><a href="#nfr-10-error-handling">NFR 10: Error Handling</a></li>
</ul></li>
<li><a href="#prevent-leakage-of-credentials">Prevent Leakage of Credentials</a></li>
<li><a href="#improve-developer-and-user-experience">Improve Developer and User Experience</a></li>
</ul></li>
<li><a href="#conclusions-and-outlook">Conclusions and Outlook</a></li>
<li><a href="#bibliography">Bibliography</a></li>
<li><a href="#sec:teaching-material">Appendix A: Teaching Material for Kubernetes Operators</a>
<ul>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#kubernetes-operators-and-their-use">Kubernetes Operators and their Use</a>
<ul>
<li><a href="#what-is-an-operator">What is an Operator?</a></li>
<li><a href="#how-do-operators-work">How do Operators work?</a></li>
<li><a href="#what-is-an-operator-sdk">What is an Operator SDK?</a></li>
</ul></li>
<li><a href="#exercise-create-a-custom-operator-with-an-sdk">Exercise: Create a Custom Operator with an SDK</a>
<ul>
<li><a href="#tldr">TL;DR</a></li>
<li><a href="#create-and-run-an-empty-operator">Create and Run an empty Operator</a></li>
<li><a href="#create-the-custom-resource-definition">Create the Custom Resource Definition</a></li>
<li><a href="#reconcile-the-custom-resource">Reconcile the Custom Resource</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="sec:introduction">Introduction</h1>
<p>Modern cloud environments solve many problems like the discovery of services and data transfer or communication between services in general. As the development of cloud-native applications (CNA) evolves, older applications move to the cloud as well.</p>
<p>However, a specific problem is not yet solved: “dynamic” trusted communication between services. For example, a service with the capability of handling OpenID Connect (OIDC) credentials wants to communicate with a service that only knows Basic Authentication. The OIDC capable service must implement some conversion mechanism or know static Basic Auth credentials to communicate with the basic auth service. In general, this introduces changes to the software. In small applications which consist of one or two services, implementing this conversion may be a feasible option. However, if we look at an application that spans over a big landscape and a multitude of services, implementing every possible authentication mechanism will be error-prone work and does not scale well<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. In practice, we encountered the given scenario at various points in time when older applications were migrated into a cloud environment and newer applications were built around it. In almost all cases, the modern software was changed to communicate with the legacy systems, instead of modifying the legacy application.</p>
<p>The goal of the project “Distributed Authentication Mesh” is to provide a solution for the problem of dynamic credential conversion. By introducing multiple elements, such as a translator in conjunction with a proxy that is capable of modifying HTTP headers in-flight, the described problem can be solved. The proposed concept makes use of a common domain language to transfer the authenticated identity of a user between services of an application. The proxy intercepts the requests and instructs the translator to transform the common language into the valid authentication format of the destination.</p>
<p>For further reading, basic knowledge about Docker and microservices is required. The implementation of the proof of concept (POC) is based on Kubernetes to display the concepts of the solution in a practical manner. In terms of authentication and authorization, the POC uses OpenID Connect and Basic Authentication, which are both described in later sections.</p>
<p>The remainder of the report describes used technologies, terminology, and concepts. Furthermore, the state of the art gives an overview of the current situation and the present solutions in practice. With the description of the distributed authentication mesh, the report shows the conceptual idea and the architecture as well as a platform-specific example in Kubernetes. The feasibility of the concept is tested with the implementation of a POC on Kubernetes. The evaluation, following the description of the solution, validates if the goals and non-goals of the solution are met. The conclusion gives an overview of the work and a summary of the project.</p>
<h1 id="sec:definitions">Definitions and Clarification of the Scope</h1>
<p>This section provides general information about the project, the context, and prerequisite knowledge. It gives an overview of the context as well as terminology and general definitions.</p>
<h2 id="scope-of-the-project">Scope of the Project</h2>
<p>This project addresses the specific problem of declarative conversion of user credentials, for example an access token, to ensure authorized communication between services. When multiple services with different authentication mechanisms communicate with each other, the services need to translate the credentials and send them to their counterpart. The goal of this project is to prevent user credentials from being transmitted to other services and to remove the need for code changes to transform credentials to another format.</p>
<p>To solve this problem, an automation component enhances services that are part of the application with additional functionality. A proxy in front of the service captures in-, and outgoing traffic to modify the <code>Authorization</code> HTTP header. Additionally, a translator transforms the original authentication data into a form of identity and encodes it with a common language format. The receiving service can validate this encoded identity and transforms the identity into valid user credentials again. This automatical transformation of credentials (e.g. from OIDC to Basic Auth) replaces manual work which may introduce code changes to either service. The deliverables of this and further projects may aid applications or APIs to communicate with each other despite different authentication mechanisms.</p>
<p>The solution may be runnable on various platforms but to provide a practical demo application, the proof of concept (POC) runs on Kubernetes. Kubernetes<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is an orchestration platform that works with containerized applications. The POC resides in an initial version in an open-source GitHub repository. The POC demonstrates that it is possible to instruct an Envoy<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> proxy to communicate with an injected service to modify authentication credentials in-flight. To separate the proposed solution from more complex concepts like a service mesh, the POC is able to run without a service mesh on a Kubernetes cluster and uses the built-in service discovery of Kubernetes to communicate.</p>
<h2 id="kubernetes-as-an-orchestration-engine">Kubernetes as an Orchestration Engine</h2>
<p>This section provides a general overview of Kubernetes. Kubernetes is a prominent orchestration engine that manages workloads on worker-nodes.</p>
<h3 id="introduction">Introduction</h3>
<p>Kubernetes is an open-source platform that manages containerized workloads and applications. Workloads may be accessed via “Services” that use a DNS naming system. Kubernetes uses declarative definitions to compare the actual state of the system with the expected state <span class="citation" data-cites="github:kubernetesWebsite">[1]</span>.</p>
<div id="fig:kubernetes_container_evolution" class="fignos">
<figure>
<img src="images/Kubernetes/Container_Evolution.png" data-short-caption="Kubernetes Container Evolution" alt="Figure 1: Container and Deployment Evolution. Description of the evolution of deployments as found on the documentation website of Kubernetes [1]. This image is licensed under the CC BY 4.0 license [2]." /><figcaption aria-hidden="true"><span>Figure 1:</span> Container and Deployment Evolution. Description of the evolution of deployments as found on the documentation website of Kubernetes <span class="citation" data-cites="github:kubernetesWebsite">[1]</span>. This image is licensed under the CC BY 4.0 license <span class="citation" data-cites="cc:CCBY4.0">[2]</span>.</figcaption>
</figure>
</div>
<p>According to Kubernetes, the way of deploying applications has evolved. As shown in Figure <a href="#fig:kubernetes_container_evolution">1</a>, the “Traditional Era” was the time when applications were deployed via FTP access and started manually (e.g. on an Apache webserver). Then the revolution to virtual machines came and technologies that could virtualize a whole operating system, such as VMWare, were born. The latest stage, “Container Era,” defines a new way deploying workloads by virtualizing processes instead of operating systems and therefore better use the given resources <span class="citation" data-cites="github:kubernetesWebsite">[1]</span>.</p>
<p>Kubernetes is a major player among others like “OpenShift” or “Cloud Foundry” in “Container Deployment” as seen in Figure <a href="#fig:kubernetes_container_evolution">1</a> and supports teams with the following features according to the documentation <span class="citation" data-cites="github:kubernetesWebsite">[1]</span>:</p>
<ul>
<li><strong>Service discovery and load balancing</strong>: Use DNS names or IP addresses to route traffic to a container and if the traffic is high and multiple instances are available, Kubernetes does load balance the traffic</li>
<li><strong>Storage orchestration</strong>: Automatically provide storage in the form of mountable volumes</li>
<li><strong>Automated rollouts and rollbacks</strong>: When a new desired state is provided Kubernetes tries to achieve the state at a controlled rate and has the possibility of performing rollbacks</li>
<li><strong>Automatic bin packing</strong>: Kubernetes only needs to know how much CPU and RAM a workload needs and then takes care of placing the workload on a fitting node in the cluster</li>
<li><strong>Self-healing</strong>: If workloads are failing, Kubernetes tries to restart the applications and even kills services that do not respond to the configured health checks</li>
<li><strong>Secret and configuration management</strong>: Kubernetes has a store for sensitive data as well as configurational data that may change the behavior of a workload</li>
</ul>
<p>The list of features is not complete. There are many concepts in Kubernetes that help to build complex deployment scenarios and enable teams to ship their applications in an agile manner.</p>
<p>Kubernetes works with containerized applications. In contrast to “plain” Docker, it orchestrates the applications and is responsible for the desired state depicted in the application manifest files. Examples of such deployments and other Kubernetes objects are available online in the documentation <span class="citation" data-cites="github:kubernetesWebsite">[1]</span><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<h3 id="terminology">Terminology</h3>
<p>In Table <a href="#tbl:kubernetes_terminology">1</a>, we state the most common Kubernetes terminology. The table provides a list of terms that is used to explain concepts like the operator pattern in Section <a href="#sec:kubernetes_operator">2.3</a>.</p>
<div id="tbl:kubernetes_terminology" class="tablenos">
<table id="tbl:kubernetes_terminology" style="width:95%;">
<caption><span>Table 1:</span> Common Kubernetes Terminology </caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="header">
<th>Term</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Docker</td>
<td>Container runtime. Enables developers to create images of applications. Those images are then run in an isolated environment. Docker images are often used in Kubernetes to define the application that Kubernetes should run.</td>
</tr>
<tr class="even">
<td>Kustomize</td>
<td>“Kustomize” is a special templating CLI to declaratively bundle Kubernetes manifests. It consists of a <code>kustomization.yaml</code> and various referenced manifest <code>yaml</code> files. It is declarative and does not allow dynamic structures. It helps administrators template applications for Kubernetes.</td>
</tr>
<tr class="odd">
<td>Container</td>
<td>Smallest possible unit in a deployment. Contains the definition of the workload. A container consists of a container image, arguments, volumes and other specific information to carry out a task.</td>
</tr>
<tr class="even">
<td>Pod</td>
<td>Composed of multiple containers. It is ran by Kubernetes as an instance of a deployment. Pods may be scaled according to definitions or “pod scalers.” Highly coupled tasks are deployed together in a pod (i.e. multiple coupled containers in a pod).</td>
</tr>
<tr class="odd">
<td>Deployment Daemonset Statefulset</td>
<td>A “Deployment” is a managed instance of a pod. Daemonsets and Statefulsets are variants of deployments. Kubernetes will run the described pod(s) with the desired replica count on the best possible worker node. Deployments may be scaled with auto-scaling mechanisms.</td>
</tr>
<tr class="even">
<td>Service</td>
<td>A service enables communication with one or multiple pods. The service contains a selector that points to a certain number of pods and then ensures that the pods are accessible via a DNS name. The name is typically a combination of the service name and the namespace (e.g. <code>my-service.namespace</code>).</td>
</tr>
<tr class="odd">
<td>Ingress</td>
<td>Incoming communication and data flow into a component. Furthermore, an “Ingress” is a Kubernetes object that defines incoming communication and configures an API gateway to route traffic to specific services.</td>
</tr>
<tr class="even">
<td>Egress</td>
<td>Outgoing communication. Egress means communication from a component to another (when the component is the source).</td>
</tr>
<tr class="odd">
<td>Resource</td>
<td>A resource is something that can be managed by Kubernetes. It defines an API endpoint on the master node and allows Kubernetes to store a collection of such API objects. Examples are: <code>Deployment</code>, <code>Service</code> and <code>Pod</code>, to name a few of the built-in resources.</td>
</tr>
<tr class="even">
<td>CRD</td>
<td>A Custom Resource Definition (CRD) enables developers to extend the default Kubernetes API. With a CRD, it is possible to create own resources which create an API endpoint on the Kubernetes API. An example of such a CRD is the <code>Mapping</code> resource of Ambassador<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</td>
</tr>
<tr class="odd">
<td>Operator</td>
<td>An operator is a software that manages Kubernetes resources and their lifecycle. Operators may use CRDs to define custom objects on which they react when some event (<code>Added</code>, <code>Modified</code> or <code>Deleted</code>) triggers on a resource. For a more in-depth description, see Section <a href="#sec:kubernetes_operator">2.3</a>.</td>
</tr>
<tr class="even">
<td>Watcher</td>
<td>A watcher is a constant connection from a client to the Kubernetes API. The watcher defines some search and filter parameters and receives events for found resources.</td>
</tr>
<tr class="odd">
<td>Validator</td>
<td>A validator is a service that may reject the creation, modification or deletion of resources.</td>
</tr>
<tr class="even">
<td>Mutator</td>
<td>Mutators are called before Kubernetes validates and stores a resource. Mutators may return JSON patches <strong>RFC6902</strong> <span class="citation" data-cites="RFC6902">[3]</span> to instruct Kubernetes to modify a resource prior to validating and storing them.</td>
</tr>
</tbody>
</table>
</div>
<div id="fig:kubernetes_parts" class="fignos">
<figure>
<img src="diagrams/component/8162dcddb05dde8c52ca3da0deb530ae.png" alt="Figure 2: UML of Kubernetes Resources (partially)" /><figcaption aria-hidden="true"><span>Figure 2:</span> UML of Kubernetes Resources (partially)</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:kubernetes_parts">2</a> shows a partial part of the named Kubernetes objects. An operator can manage resources such as deployments or services. The operator may manage other resources or custom resources based on the configuration it uses. A deployment contains a pod, which contains containers. The container is the effective unit of work, defined by an image. The service allows communication with a specific container on a configured port.</p>
<h2 id="sec:kubernetes_operator">The Operator Pattern</h2>
<p>An operator in Kubernetes is an extension to the Kubernetes API itself. A custom operator typically manages the whole lifecycle of an application it manages <span class="citation" data-cites="dobies:KubernetesOperators">[4]</span>. An operator can further be used to reconcile normal Kubernetes resources or any combination thereof.</p>
<p>Some examples of application operators are:</p>
<ul>
<li>Prometheus Operator<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>: Manages instances of Prometheus in a cluster</li>
<li>Postgres Operator<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>: Manages PostgreSQL clusters inside Kubernetes, with the support of multiple instance database clusters</li>
</ul>
<p>There exists a broad list of operators, which can be (partially) viewed on <a href="https://operatorhub.io/">https://operatorhub.io</a>.</p>
<div id="fig:kubernetes_operator_workflow" class="fignos">
<figure>
<img src="diagrams/sequences/c28fd7ec0678a131801e6ddf95a34c7e.png" alt="Figure 3: Kubernetes Operator Workflow" /><figcaption aria-hidden="true"><span>Figure 3:</span> Kubernetes Operator Workflow</figcaption>
</figure>
</div>
<p>In Figure <a href="#fig:kubernetes_operator_workflow">3</a>, we depict the general workflow of an event that is managed by an operator. When an operator is installed and runs on a Kubernetes cluster, it registers “Resource Watchers” with the API and receives notifications if the master node modifies resources. The overviewed events are “Added,” “Modified” and “Deleted.” There are two additional events that may be returned by the API (“Error” and “Bookmark”), but they are typically not needed for reconciliation.</p>
<p>When the user interacts with the Kubernetes API (e.g. via the <code>kubectl</code> executable) and creates a new instance of a resource, the API will first call any “Mutator” in a serial manner. After the mutators, the API will call any “Validators” in parallel and if no validator objects against the creation, the API will then store the resource and tries to apply the transition for the new desired state. Now, the operator receives a notification about the watched resource and may interact with the event. Such action may include updating resources, create more resources or even delete other instances.</p>
<h2 id="sec:kubernetes_sidecar">The Sidecar Pattern</h2>
<p>According to the authors of <span class="citation" data-cites="burns:DesignPatternsForContainerSystems">[5]</span>, the sidecar pattern is the most common pattern for multi-container deployments. Sidecars are containers that enhance the functionality of the main container in a pod. An example for such a sidecar is a log collector, that collects log files written to the file system and forwards them towards some log processing software <span class="citation" data-cites="burns:DesignPatternsForContainerSystems">[5]</span>. Another example is the Google CloudSQL Proxy<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>, which provides access to a CloudSQL instance from a pod without routing the whole traffic through Kubernetes services.</p>
<div id="fig:kubernetes_sidecar" class="fignos">
<figure>
<img src="diagrams/component/7618077b5ad439978876dcc9b5dfbf8d.png" data-short-caption="Example of a Sidecar Container" alt="Figure 4: Sidecar container extending a main container in a pod. As example, this could be a log collector [5]." /><figcaption aria-hidden="true"><span>Figure 4:</span> Sidecar container extending a main container in a pod. As example, this could be a log collector <span class="citation" data-cites="burns:DesignPatternsForContainerSystems">[5]</span>.</figcaption>
</figure>
</div>
<p>The example shown in Figure <a href="#fig:kubernetes_sidecar">4</a> is extensible. Such sidecars may be injected by a mutator or an operator to extend functionality.</p>
<p>Common use cases for sidecars include controlling the data flow in a cluster with a service mesh<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, providing access to secure locations<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> or performing additional tasks such as collecting logs of an application. Since sidecars are tightly coupled to the original application, they scale with the pod. It is not possible to scale a sidecar without scaling the pod - and therefore the application - itself.</p>
<h2 id="sec:service_mesh">Controlling the Data with a Service Mesh</h2>
<p>A “Service Mesh” is a dedicated infrastructure layer that handles intercommunication between services. It is responsible for the delivery of requests in a modern cloud application <span class="citation" data-cites="li:ServiceMesh">[6]</span>. An example from the practice is “Istio”<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>. When using Istio, the applications do not need to know if there is a service mesh installed or not. Istio will inject a sidecar (see Section <a href="#sec:kubernetes_sidecar">2.4</a>) into the deployments to handle the communication between services.</p>
<p>The service mesh provides a set of features <span class="citation" data-cites="li:ServiceMesh">[6]</span>:</p>
<ul>
<li><strong>Service discovery</strong>: The mechanism to locate and communicate with a workload / service. In a cloud environment, the location of services will likely change, thus, the service mesh provides a way to access the services in the cloud.</li>
<li><strong>Load balancing</strong>: As an addition to the service discovery, the mesh provides load balancing mechanisms as is done by Kubernetes itself.</li>
<li><strong>Fault tolerance</strong>: The router in a service mesh is responsible to route traffic to healthy services. If a service is unavailable or even reports a crash, traffic should not be routed to this instance.</li>
<li><strong>Traffic monitoring</strong>: In contrast to the default Kubernetes possibilities, with a service mesh, the traffic from and to various services can be monitored in detail. This offers the opportunity to derive reports per target, success rates and other metrics.</li>
<li><strong>Circuit breaking</strong>: The ability to cut off an overloaded service and back off the remaining requests instead of totally failing the service under stress. A circuit breaker pattern measures the failure rate of a service and applies states to the service: “Closed” - requests are passed to the service, “Open” - requests are not passed to this instance, “Half-Open” - only a limited number is passed <span class="citation" data-cites="montesi:CircuitBreakers">[7]</span>.</li>
<li><strong>Authentication and access control</strong>: Through the control plane, a service mesh may define the rules of communication. It defines which services can communicate with one another.</li>
</ul>
<p>As observed in the list above, many of the features of a service mesh are already provided by Kubernetes. Service discovery, load balancing, fault tolerance and - though limited - traffic monitoring is already possible with Kubernetes. Introducing a service mesh into a cluster enables administrators to build more complex scenarios and deployments.</p>
<h2 id="authentication-authorization-and-security">Authentication, Authorization, and Security</h2>
<p>This section provides an introduction to the used authentication mechanisms. The proposed solution is capable of handling more than the described schemes, but for the implementation of the POC, Basic Authentication and OIDC were used.</p>
<h3 id="sec:basic_auth">Basic Authentication (RFC7617)</h3>
<p>The <code>Basic</code> authentication is a trivial authentication scheme (i.e. a way to prove the identity of an entity) that accepts a username and a password encoded in Base64. To transmit the credentials, a construct with the schematics of <code>&lt;username&gt;:&lt;password&gt;</code> is created and inserted into the HTTP request as the <code>Authorization</code> header with the prefix <code>Basic</code> <span class="citation" data-cites="RFC7617">[8]</span>. An example with the username <code>ChristophBuehler</code> and password <code>SuperSecure</code> would result in the following header:</p>
<blockquote>
<p><code>Authorization: Basic Q2hyaXN0b3BoQnVlaGxlcjpTdXBlclNlY3VyZQ==</code></p>
</blockquote>
<h3 id="sec:auth_oidc">OpenID Connect (OIDC)</h3>
<p>OpenID Connect is not defined in a RFC. The specification is provided by the OpenID Foundation (OIDF). OIDC extends OAuth, which is defined by <strong>RFC6749</strong>.</p>
<p>OpenID Connect is an authentication scheme, that extends/complements the <code>OAuth 2.0</code> framework. OAuth itself is an authorization framework, that enables applications to gain access to a resource (API or other) <span class="citation" data-cites="RFC6749">[9]</span>. OAuth 2.0 only deals with authorization and grants access to data and features on a specific application. OAuth by itself does not define <em>how</em> the credentials are transmitted and exchanged <span class="citation" data-cites="RFC6749">[9]</span>. OIDC adds additional logic to OAuth 2.0 that defines <em>how</em> these credentials must be exchanged. Thus, OIDC enables login and profile capabilities in any application that uses OIDC <span class="citation" data-cites="spec:OIDC">[10]</span>.</p>
<div id="fig:oidc_code_flow" class="fignos">
<figure>
<img src="diagrams/sequences/d5594020a93a4bfd931b27633547116f.png" data-short-caption="OpenID Connect Code Flow" alt="Figure 5: OIDC code authorization flow [10]. Only contains the credential flow, without the explicit OAuth part. OAuth handles the authorization whereas OIDC handles the authentication." /><figcaption aria-hidden="true"><span>Figure 5:</span> OIDC code authorization flow <span class="citation" data-cites="spec:OIDC">[10]</span>. Only contains the credential flow, without the explicit OAuth part. OAuth handles the authorization whereas OIDC handles the authentication.</figcaption>
</figure>
</div>
<p>When a user wants to authenticate himself with OIDC, one of the possible “flows” is the “Authorization Code Flow.” Other possible flows are the “Implicit Flow” and the “Hybrid Flow” <span class="citation" data-cites="spec:OIDC">[10]</span>. Figure <a href="#fig:oidc_code_flow">5</a> depicts the “Authorization Code Flow.” A user that wants to access a certain resource (e.g. an API) on a relying party (i.e. something that relies on the information about the user) and is not authenticated and authorized, the relying party forwards the user to the identity provider (IdP). The user provides his credentials to the IdP and is returned to the relying party with an authorization code. The relying party can then exchange the authorization code for valid tokens on the token endpoint of the IdP. Typically, <code>access_token</code> and <code>id_token</code> are provided. While the <code>id_token</code> must be a JSON Web Token (JWT), the <code>access_token</code> can be in any format <span class="citation" data-cites="spec:OIDC">[10]</span>.</p>
<p>An example of an <code>id_token</code> in JWT format may be:</p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
yJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.
flKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code></pre>
<p>The stated JWT token contains:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;alg&quot;</span><span class="fu">:</span> <span class="st">&quot;HS256&quot;</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;typ&quot;</span><span class="fu">:</span> <span class="st">&quot;JWT&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;sub&quot;</span><span class="fu">:</span> <span class="st">&quot;1234567890&quot;</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Doe&quot;</span><span class="fu">,</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;iat&quot;</span><span class="fu">:</span> <span class="dv">1516239022</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="sec:zero-trust">Zero Trust Environment</h3>
<p>“Zero Trust” is a security model with a focus on protecting data and user credentials. The basic idea of zero trust is to assume that an attacker is always present. It does not matter if the application resides within an enterprise network, zero trust assumes that enterprise networks are no more trustworthy than any other public network. As a consequence of zero trust, applications are not implicitly trusted. Therefore, user credentials must be presented and validated for each access to a resource <span class="citation" data-cites="rose:zero-trust">[11]</span>. Zero trust can be summarized with: “Never trust, always verify.”</p>
<h1 id="sec:state_of_the_art">State of the Art and the Practice</h1>
<p>This section gives an overview of the current state of the art and the practice. Furthermore, it states the deficiencies that this project tries to solve.</p>
<h2 id="accessing-legacy-systems-from-modern-systems">Accessing Legacy Systems from Modern Systems</h2>
<p>In cloud environments, a solved problem is the transmission of arbitrary data from one endpoint to another. Modern programming languages (like .NET, Python and Node.js) provide ways to handle communication with other endpoints and APIs. To transmit data between services in a cloud environment, an application can use the HTTP protocol, gRPC<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>, or any other protocol to encode the requests and responses. In the case of a service mesh, a sidecar is injected into the pod that contains a proxy to handle data transmission between the services.</p>
<p>In terms of authentication and authorization, there is a variety of schemes that enable an application to authenticate and authorize its users. OpenID Connect (OIDC) (see Section <a href="#sec:auth_oidc">2.6.2</a>) is a modern authentication scheme, that complements the OAuth 2.0 framework, which in turn handles authorization <span class="citation" data-cites="spec:OIDC">[10]</span>. OAuth only defines how to grant access to specific resources (like APIs) but not how the access tokens are exchanged. OIDC fills that space by introducing authentication flows (e.g. “Authorization Code Flow” in Figure <a href="#fig:oidc_code_flow">5</a>). OAuth in combination with OIDC provides a modern and secure way of authentication and authorizing users against an API.</p>
<p>Modern software architectures that are specifically designed for the cloud are called “Cloud Native Applications” (CNA). A CNA can be defined as <span class="citation" data-cites="kratzke:CloudNativeApplications">[12]</span>:</p>
<blockquote>
<p>“A cloud-native application is a distributed, elastic and horizontal scalable system composed of (micro)services which isolates state in a minimum of stateful components. The application and each self-contained deployment unit of that application is designed according to cloud-focused design patterns and operated on a self-service elastic platform.”</p>
</blockquote>
<p>However, with CNAs and the general movement to cloud environments and digitalization, not all applications get that chance to adjust. For various reasons like budget, time or technical risks and skill availability, legacy applications and monoliths are not always refactored or re-written before they are deployed into a cloud environment. If the legacy applications (for example an old ERP system) are mixed with modern systems, then the need of “translation” arises. Assuming that the modern part is a secure application that uses OIDC to authenticate its users and the application needs to fetch data from a legacy system. The legacy application does not understand OIDC, thus, either the modern or the legacy application must receive code changes (i.e. enable the application to convert the user credentials to the scheme of the target service) to enable communication between the services. Following the previous assumption, the code changes will likely be introduced into the modern application, since it is presumably better maintainable and deployable than the legacy app. Hence, the modern application receives changes that may introduce new bugs or vulnerabilities. If new code is introduced into an application, “normal” software bugs may be created and external dependencies (such as libraries for authentication and authorization) may import vulnerabilities caused by bugs or by deviation from standards.</p>
<div id="fig:is_solution_components" class="fignos">
<figure>
<img src="diagrams/component/2864ffa3a0a44cf5894cb9dd9d553bb1.png" data-short-caption="Microservice Architecture with Legacy Components" alt="Figure 6: Microservice architecture that contains modern applications as well as legacy services." /><figcaption aria-hidden="true"><span>Figure 6:</span> Microservice architecture that contains modern applications as well as legacy services.</figcaption>
</figure>
</div>
<p>We consider the components in Figure <a href="#fig:is_solution_components">6</a>:</p>
<ul>
<li><strong>User</strong>: A person with access to the application</li>
<li><strong>Single Page Application</strong>: A modern single page application (SPA)</li>
<li><strong>Identity and Access Management (IAM)</strong>: Identity Provider for the solution (does not necessarily reside in the same cloud)</li>
<li><strong>Cloud Native Application (CNA)</strong>: A modern API application and primary access point for the client</li>
<li><strong>Legacy System</strong>: Legacy service that is called by service a to fetch some additional data</li>
</ul>
<p>In the practice, we encountered the stated scenario at various points in time. Legacy services may not be the primary use case. Another example is the usage of third-party applications without any access to the source code.</p>
<div id="fig:is_solution_process" class="fignos">
<figure>
<img src="diagrams/sequences/01935ac180bf9b8a5c1eff1773b1570f.png" data-short-caption="Current Process of Legacy Communication" alt="Figure 7: Current state of the art of accessing legacy systems from modern services with differing authentication schemes." /><figcaption aria-hidden="true"><span>Figure 7:</span> Current state of the art of accessing legacy systems from modern services with differing authentication schemes.</figcaption>
</figure>
</div>
<p>The invocation sequence in Figure <a href="#fig:is_solution_process">7</a> shows the process of communication in such a scenario. In Figure <a href="#fig:is_solution_process">7</a>, the SPA (Client) authenticates against an arbitrary IAM. The CNA is the modern backend that supports the SPA as a backend API. Therefore, the CNA provides functionality for the SPA. The legacy application, for example an old ERP with order information, was moved into the cloud, but is not refactored nor re-written to communicate with modern authentication technologies.</p>
<p>In this scenario, the SPA calls some API on the CNA that - in turn - will call the legacy system to get additional information to present to the user. Since the SPA and the CNA communicate with the same authentication technology, the call is straightforward. The SPA authenticates itself and obtains an access token. When calling the service (the CNA), the token is transmitted and the service can check with the IAM if the user is authorized to access the system. When the CNA calls the legacy system for additional information, it is required to translate the user-provided credentials (the access token) to a format that the legacy system understands. In the example, the legacy system is only able to handle Basic Authentication (RFC7617), as explained in Section <a href="#sec:basic_auth">2.6.1</a>. This means, if the CNA wants to communicate with the legacy system, it must implement some translation logic to change the user credentials into the typical Basic Authentication Base64 encoded format of <code>&lt;Username&gt;:&lt;Password&gt;</code>. Hence, code changes are introduced to the CNA since the legacy system is not likely to be easily maintainable.</p>
<h2 id="external-authentication-and-identity-transport">External Authentication and Identity Transport</h2>
<p>In practice, no current solution exists that allows credentials to be transformed between authentication schemes. The service mesh “Istio” provides a mechanism to secure services that communicate with mTLS (mutual TLS) <span class="citation" data-cites="istio:website:mtls">[13]</span> as well as an external mechanism to provide custom authentication and authorization capabilities <span class="citation" data-cites="istio:website:custom-authz">[14]</span>. The concept of Istio works well when all applications in the system share the same authentication scheme. As soon as two or more schemes are in place, the need for transformation arises again.</p>
<p>In fact, the external authentication feature of Istio is based on Envoy. Istio uses Envoy as an injected sidecar. Another prominent API gateway, “NGINX”<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>, implements a similar external authentication mechanism <span class="citation" data-cites="nginx:website:ext-authz">[15]</span>. However, Envoy implements a more fine-grained control over the HTTP request. As an external authentication service for Envoy, the result may change HTTP headers in the request and the response. While both gateways offer a way of external authentication and authorization, they cannot transform the user credentials on their own. In Envoy, the external service may attach or modify HTTP headers, while in NGINX, the external service may only allow or reject a request.</p>
<p>There exist techniques, such as SAML (Security Assertion Markup Language) or JWT (JSON web token) profiles, to transmit an identity of a user to other services. However, SAML only describes the format of the identity itself, not the translation between varying types of credentials. SAML works when all participating services understand SAML as well. If a legacy system is not able to parse and understand SAML, the same problem arises.</p>
<p>All the discussed technologies and applications above do not support the dynamic conversion of user credentials. While Istio solves the communication and enables mTLS between services, it does not translate credentials between services. SAML gives a common format for an identity of a user, but it is an authentication scheme on its own. Thus, the “translation problem” still exists.</p>
<h2 id="sec:deficiencies">Missing Dynamic Credential Transformation</h2>
<p>The situation described in the previous sections introduces several problems. It does not matter whether the legacy system is a third-party application to which no code changes can be applied to, or if it is an application that cannot be updated for the time being. Most likely, the code change to provide the ability to communicate will be introduced into the CNA. This adds the risk of errors since new code must be produced, which would not be necessary if the legacy service was refactored. Also, changing the CNA to communicate with the legacy software may be a feasible solution in a small setup. But as the landscape of the application grows, this solution does not scale well.</p>
<div id="fig:matrix_problem" class="fignos">
<figure>
<img src="diagrams/component/02c05c239b61a9f6d98dd70d835ce889.png" alt="Figure 8: Matrix Problem in Service Landscape" /><figcaption aria-hidden="true"><span>Figure 8:</span> Matrix Problem in Service Landscape</figcaption>
</figure>
</div>
<p>The matrix problem, as depicted in Figure <a href="#fig:matrix_problem">8</a>, shows that the number of conversion mechanisms increases with each service and each authentication method. As the landscape and the different methods of authentication grow, it is not a feasible solution to implement every authentication scheme in all the callers. In Figure <a href="#fig:matrix_problem">8</a>, “Caller 1” is required to transform the user credentials into four different formats to communicate with services one to four. When another caller enters the landscape, it must implement the same four mechanisms as well.</p>
<p>Another issue that emerges with this transformation of credentials: The credentials leak into the trust zone. As long as each service is in the same trust zone (for example, in the same data center in the same cluster behind the same API gateway), this may not be problematic. As soon as the communication is between data centers, the communication and the credentials must be protected. It is not possible to create a zero trust (the assumption, that an attacker is always present, see Section <a href="#sec:zero-trust">2.6.3</a>) environment with the need of knowledge about the target’s authentication schemes.</p>
<div id="fig:zero_trust_environment" class="fignos">
<figure>
<img src="diagrams/component/db721ae09ba5a3de9257a54712f5b091.png" alt="Figure 9: Zero Trust Environment" /><figcaption aria-hidden="true"><span>Figure 9:</span> Zero Trust Environment</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:zero_trust_environment">9</a> shows the problem when communicating between trust zones. While the two services in “Trust Zone A” may implicitly trust each other, because they are in the same trust zone behind the same API gateway, the problem of leaking credentials is not critical. As soon as the three zones communicate with each other, credentials leave the trust zone and enter another zone. When implementing zero trust, each service in the system must verify the integrity and validity of the presented credentials again. There must not be any implicit trust based on a trust zone.</p>
<p>Service meshes may provide a way to secure communication between services, but they are not able to transform credentials to a required format for any legacy application yet. It would be a possible solution to enable service meshes to transform credentials. However, service meshes introduce another layer of complexity on top of the environment. Such a system should be easy to use.</p>
<p>Other technologies - such as credential vaults - have a similar problem. The vault is the central weakness in the system. If the vault is attacked, the whole trust zone may fail. While a credential vault would provide a way to share credentials between services, it does not mitigate the need of transformation. A vault, like “Vault by HashiCorp”<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>, typically provides a secure way to inject credentials into a system. The vaults do not transform credentials for the destination. However, such a vault could be used as secure storage of credentials for such a system that enables the described transformation. In the example of Figure <a href="#fig:is_solution_process">7</a>, the secure vault could be used to store the static Basic Authentication credentials for the legacy service. The transformer can then access the vault to fetch the needed credentials for the target system.</p>
<h1 id="sec:solution">Distributed Authentication Mesh</h1>
<p>This section gives a general overview of the proposed solution. Furthermore, boundaries of the solution are provided along with common software engineering elements like requirements, non-functional requirements, and the documentation of the architecture.</p>
<p>The proposed architecture provides a generic description for a solution to the described problem. For this project, a proof of concept (POC) gives insights into the general topic of manipulating HTTP requests in-flight. The POC is implemented to run on a Kubernetes cluster to provide a practical example.</p>
<h2 id="definition">Definition</h2>
<p>A solution for the stated problems in Section <a href="#sec:deficiencies">3.3</a> must be able to transform arbitrary credentials into a format that the target service understands. For this purpose, the architecture contains a service that runs as a sidecar among the target service. This sidecar intercepts requests to the target and transforms the Authorization HTTP header. The sidecar is - like in a service mesh - used to intercept inbound and outbound traffic.</p>
<p>However, the solution <strong>must not</strong> interfere with the data flow itself. The problem of proxying data from point A to B is well solved. In the given work, an Envoy proxy delivers data between the services. Envoy allows the usage of an external service to modify requests in-flight.</p>
<h2 id="goals-and-non-goals-of-the-project">Goals and Non-Goals of the Project</h2>
<p>This section presents the functional and non-functional requirements and goals for the solution. It is important to note that the implemented proof of concept (POC) will not achieve all goals. Further work is needed to implement a solution according to the architecture that adheres to the stated requirements.</p>
<p>In Table <a href="#tbl:functional-requirements">2</a>, we present the list of functional requirements or goals (REQ) for the proposed solution and the project in general.</p>
<div id="tbl:functional-requirements" class="tablenos">
<table id="tbl:functional-requirements" style="width:86%;">
<caption><span>Table 2:</span> Functional Requirements </caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>REQ 1</td>
<td>The translator module must be able to transform given credentials into the specified common language and the common format back into valid credentials.</td>
</tr>
<tr class="even">
<td>REQ 2</td>
<td>The translator is injected as a sidecar into the solution. In Kubernetes this is done via an operator.</td>
</tr>
<tr class="odd">
<td>REQ 3</td>
<td>Beside the translator, an Envoy proxy is injected into the service in question to handle the data flow. This injection is performed by the operator as well.</td>
</tr>
<tr class="even">
<td>REQ 4</td>
<td>Translators do only modify HTTP headers. They do not interfere with the data that is transmitted. Any information that needs to be forwarded must reside in the HTTP headers.</td>
</tr>
<tr class="odd">
<td>REQ 5</td>
<td>The automation engine can decide which elements are relevant for the authentication mesh.</td>
</tr>
<tr class="even">
<td>REQ 6</td>
<td>The automation engine - if it exists - enhances objects with the proxy and translator engine.</td>
</tr>
</tbody>
</table>
</div>
<p>In Table <a href="#tbl:non-functional-requirements">3</a>, we show the non-functional requirements or non-goals (NFR) for the proposed solution.</p>
<div id="tbl:non-functional-requirements" class="tablenos">
<table id="tbl:non-functional-requirements" style="width:95%;">
<caption><span>Table 3:</span> Non-Functional Requirements </caption>
<colgroup>
<col style="width: 11%" />
<col style="width: 83%" />
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>NFR 1</td>
<td>First and foremost, the solution <strong>must not</strong> be less secure than current solutions.</td>
</tr>
<tr class="even">
<td>NFR 2</td>
<td>The solution must adhere to current best practices and security mechanisms. Furthermore, it <strong>must</strong> be implemented according to the standards of the practice to mitigate security issues as stated in the OWASP Top Ten (<a href="https://owasp.org/www-project-top-ten" class="uri">https://owasp.org/www-project-top-ten</a>).</td>
</tr>
<tr class="odd">
<td>NFR 3</td>
<td>The concept of the solution is applicable to cluster orchestration software other than Kubernetes. The architecture provides a general way of solving the stated problem instead of giving a proprietary solution for one vendor. The concept should even be realizable for non-orchestration platforms like a Windows operating system.</td>
</tr>
<tr class="even">
<td>NFR 4</td>
<td>The translation of the credentials should not extensively impact the timeframe of an arbitrary request. In production mode, the additional time to check and transform the credentials <strong>should</strong> not exceed 100ms. This is a general recommendation and some authentication mechanism may exceed the stated 100ms.</td>
</tr>
<tr class="odd">
<td>NFR 5</td>
<td>The solution is modular. It is extensible with additional “translators” that provide the means of transforming the given credentials to other target formats.</td>
</tr>
<tr class="even">
<td>NFR 6</td>
<td>The solution may run with or without a service mesh. It is a goal that the solution can run without a service mesh to reduce the overall complexity, but if a service mesh is already in place, the solution must be able to work with the provided infrastructure.</td>
</tr>
<tr class="odd">
<td>NFR 7</td>
<td>The architecture <strong>must</strong> be scalable. The provided software must be able to scale according to the business needs of the overall system.</td>
</tr>
<tr class="even">
<td>NFR 8</td>
<td>Each translator <strong>should</strong> only handle one authentication scheme to ensure separation of concerns and scalability of the whole solution.</td>
</tr>
<tr class="odd">
<td>NFR 9</td>
<td>The solution depends on an external software for data transmission. The solution <strong>must not</strong> interfere with the data plane. Error handling of the data plane is handled by the external application.</td>
</tr>
<tr class="even">
<td>NFR 10</td>
<td>The solution handles errors in the translation and the automation engine according to the architectural description.</td>
</tr>
</tbody>
</table>
</div>
<p>These goals and non-goals define the first list of REQ and NFR. During future work, this list may change to adjust to new challenges.</p>
<h2 id="differentiation-from-other-technologies">Differentiation from other Technologies</h2>
<p>To distinguish this project from other technologies, this section gives a differentiation to two specific topics. The given topics stand for a general architectural idea and the contrast to the presented solution.</p>
<h3 id="sec:saml">Security Assertion Markup Language</h3>
<p>The “Security Assertion Markup Language” (SAML) is a so-called “Federated Identity Management” (FIdM) standard. SAML, OAuth, and OIDC represent the three most popular FIdM standards. SAML is an XML framework for transmitting user data, such as authentication, entitlement, and other attributes, between services and organizations <span class="citation" data-cites="naik:SAMLandFIdM">[16]</span>.</p>
<p>While SAML is a partial solution for the stated problem, it does not cover the use case when credentials need to be transformed to communicate with a legacy system. SAML enables services to share identities in a trustful way, but all communicating partners must implement the SAML protocol to be part of the network. This project addresses the specific transformation of credentials into a format for some legacy systems. The basic idea of SAML may be used as a baseline of security and the general idea of processing identities.</p>
<h3 id="sec:ws-deathstar">WS-*</h3>
<p>The term “WS-*” contains a broad class of specifications within the “Web Services Description Language” (WSDL) and “Simple Object Access Protocol” (SOAP) context. The specifications were created by the World Wide Web Consortium (W3C). However, the consortium never finished and released the specification.</p>
<p>SOAP is a protocol to exchange information between services in an XML encoded message. It provides a way of communication between web services. A SOAP message consists of an “envelope” that contains a “body” and an optional “header” to transfer encoded objects. An example SOAP message is <span class="citation" data-cites="curbera:SOAP-and-WSDL">[17]</span>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>POST /travelservice</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>SOAPAction: &quot;http://www.acme-travel.com/checkin&quot;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>Content-Type: text/xml; charset=&quot;utf-8&quot;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>Content-Length: nnnn</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="ot">SOAP:Envelope</span> <span class="er">xmlns:SOAP</span><span class="ot">=</span><span class="st">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="ot">SOAP:Body</span><span class="er">&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">&lt;et:eTicket</span> <span class="er">xmlns:et</span><span class="ot">=</span><span class="st">&quot;http://www.acme-travel.com/eticket/schema&quot;</span>&gt;</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="ot">et:passengerName</span> <span class="er">first</span><span class="ot">=</span><span class="st">&quot;Joe&quot;</span><span class="ot"> last=</span><span class="st">&quot;Smith&quot;</span>/&gt;</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="ot">et:flightInfo</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="er">airlineName</span><span class="ot">=</span><span class="st">&quot;AA&quot;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="ot">        flightNumber=</span><span class="st">&quot;1111&quot;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="ot">        departureDate=</span><span class="st">&quot;2002-01-01&quot;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="ot">        departureTime=</span><span class="st">&quot;1905&quot;</span>/&gt;</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="er">et:eTicket</span>&gt;</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="er">SOAP:Body</span>&gt;</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;</span>/SOAP:Envelope&gt;</span></code></pre></div>
<p>WSDL is an XML-based description of a web service. The goal of WSDL is to provide a description of methods that may be called on a web service. WSDL fills the needed endpoint description that SOAP is missing. While SOAP provides basic communication, WSDL defines the exact methods that are callable on an endpoint <span class="citation" data-cites="curbera:SOAP-and-WSDL">[17]</span>.</p>
<p>The distributed authentication mesh differs from WS-* such that there is no exact specification required for the target service. While the solution contains a common domain language - a SOAP-like protocol to encode data - it does not specify the endpoints of a service. The solution merely interacts with the HTTP request that targets a specific service and transforms the authentication information from the common format to the specific format. Of course, certain authentication schemes need additional information to generate their user credentials out of the data.</p>
<h2 id="use-case-of-dynamic-credential-transformation">Use Case of Dynamic Credential Transformation</h2>
<p>The usefulness of such a solution shows when “older” or monolithic software moves to the cloud or when third-party software is used that provides no accessible source code.</p>
<h3 class="unlisted unnumbered" id="communicate-with-legacy-software">Communicate with legacy software</h3>
<p>Precondition: Cloud-Native Application (CNA) and legacy software is deployed with their respective manifests and the sidecars of the authentication mesh are running.</p>
<ol type="1">
<li>The user authenticates against the used IAM of the CNA</li>
<li>The user tries to access a resource on the legacy software</li>
<li>The CNA creates a request and “forwards” the credentials of the user</li>
<li>The proxy intercepts the request and forwards the credentials to the transformer</li>
<li>The transformer verifies the credentials and transforms them into a domain-specific format (e.g. JWT Profile or SAML identity)</li>
<li>The proxy replaces the headers and forwards the request</li>
<li>The receiving proxy forwards the domain-specific format to the translator of the target</li>
<li>The translator casts the credentials into the specific authentication scheme credentials (e.g. Basic Authentication credentials in the form of <code>Username:Password</code>)</li>
<li>The receiving proxy forwards the request to the target service with the updated HTTP headers</li>
</ol>
<p>Postcondition: The communication has taken place and no credentials have left the source service (the CNA). The legacy service does not know what specific authentication scheme was used by the source to identify the user.</p>
<p>This use case can be changed such that the receiving service is not a legacy software but some third-party application where the source code is not accessible.</p>
<h2 id="architecture-of-the-solution">Architecture of the Solution</h2>
<p>The following sections provide an architectural overview of the proposed solution. The brief description gives an initial overview of the architecture and the conceptional idea. Afterward, an abstract architecture describes the concepts behind the distributed authentication mesh. Then the architecture is concretized with platform-specific examples based on Kubernetes.</p>
<p>The reader should note that the proposed architecture does not match the implementation of the POC to the full extent. The goal of this project is to provide an abstract idea to implement such an authentication mesh, while the POC proves the ability to modify HTTP requests in-flight.</p>
<h3 id="brief-description">Brief Description</h3>
<p>In general, when some service wants to communicate with another service and the user does not need to authenticate himself, most likely, a federated identity is in use. That means that at some point, the user validates his own identity and is authenticated in the whole zone of trust. This does not contradict a zero-trust environment. A federated identity can be validated by each service and thus may be used in a zero-trust environment.</p>
<p>To achieve such a federated identity with diverging authentication schemes, the solution converts validated credentials (like access tokens) to a domain specific language (DSL). This format, in conjunction with a proof of the sender, validates the identity over the wire in the communication between services without the need of additional authentication. When all parties of a communication are trusted through verification, no information about the effective credentials leaks into the communication between services.</p>
<p>The basic idea of the distributed authentication mesh is to replace any user credentials from an outgoing HTTP request with the DSL representation of the user identity. On the receiving side, the DSL encoded identity in the incoming HTTP request is transformed to the valid user credentials for the target service.</p>
<p>Since the topic of the mesh is security, error handling is a delicate matter. The mesh does depend on existing infrastructure and principles. Thus, error handling is limited to the translator engine. When the translator encounters any error, the request is denied.</p>
<h3 id="sec:abstract_architecture">Abstract and Conceptional Architecture</h3>
<p>This section describes the architecture of the proposed solution in an abstract and generalized way. The concepts are not bound to any specific platform or a specific implementation nor required to run in a cloud environment. The concepts could be implemented as a “fat-client” solution for a Windows machine.</p>
<div id="fig:solution_architecture" class="fignos">
<figure>
<img src="diagrams/component/fd583116a4ca7052d0033400d570bb3c.png" alt="Figure 10: Abstract Solution Architecture" /><figcaption aria-hidden="true"><span>Figure 10:</span> Abstract Solution Architecture</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:solution_architecture">10</a> shows the abstract solution architecture. In the “support” package, generally available elements provide utility functions to the mesh. The solution requires a public key infrastructure (PKI) to deliver key material for signing and validation purposes. This key material may also be used to secure the communication between the nodes (or applications). Configuration and secret storage enable the applications to store and retrieve configurations and secret elements like passwords or key material.</p>
<p>Additionally, an optional automation component watches and manages applications. This component enhances the application services with the required components to participate in the distributed authentication mesh. Such a component is strongly suggested when the solution is used in a cloud environment to enable dynamic usage of the mesh. The automation injects the proxies, translators, and the required configurations for the managed components.</p>
<p>A (managed) application service consists of three parts. The source (or destination) service, which represents the deployed application itself, a translator that manages the transformation between the DSL of the identity and the implementation specific authentication format, and a proxy that manages the communication from and to the application.</p>
<p>The communication between instances in the authentication mesh is handled by the proxies. The mesh must not interfere with the data transmission, it is only responsible for modifying HTTP headers. Handling errors on the data plane is not part of the mesh and must be done by the implementation of the proxy.</p>
<h3 id="sec:specific_architecture">Platform-Specific Example in Kubernetes</h3>
<p>For these sections, the architecture shows elements of a Kubernetes cloud environment. The reason is to describe the specific architecture the context of the practice. However, the general idea of the solution may be deployed in various environments and is not bound to a cloud infrastructure. Table <a href="#tbl:kubernetes_terminology">1</a> gives an overview of used terms and concepts in Kubernetes which are used to describe the platform-specific architecture.</p>
<p>Since the example is Kubernetes specific, error handling and recovery mechanisms of Kubernetes can be used. So if a part of the mesh crashes due to an unexpected error, Kubernetes is responsible for restarting that part. Furthermore, Kubernetes is the orchestrator which takes actions to provide the running state of all applications. If any errors are encountered, proper logging must be provided.</p>
<h4 id="automation-with-an-operator">Automation with an Operator</h4>
<p>In the case of a Kubernetes infrastructure, the automation part is done by an operator pattern as explained in Section <a href="#sec:kubernetes_operator">2.3</a>. The automation part of the mesh is optional. When no automation is provided, the required proxy and translator elements must be started and maintained by some other means. However, in the context of Kubernetes, an operator pattern enables an automated enhancement and management of applications.</p>
<div id="fig:automation_architecture" class="fignos">
<figure>
<img src="diagrams/component/a7a7b94311322d8d8b89f54aadb5b56b.png" alt="Figure 11: Automation with an Operator in a Kubernetes Environment" /><figcaption aria-hidden="true"><span>Figure 11:</span> Automation with an Operator in a Kubernetes Environment</figcaption>
</figure>
</div>
<p>The operator in Figure <a href="#fig:automation_architecture">11</a> watches the Kubernetes API for changes. When deployments or services are created, the operator enhances the respective elements. “Enhancing” means that additional containers are injected into a deployment as sidecars. The additional containers contain the proxy and the translator. While the proxy manages incoming and outgoing communication, the translator manages the transformation of credentials from and to the DSL.</p>
<div id="fig:automation_relevant_parts" class="fignos">
<figure>
<img src="diagrams/states/60e68cb41e4e783831d07edfc057080a.png" alt="Figure 12: Determination of the Relevance of a Deployment or a Service" /><figcaption aria-hidden="true"><span>Figure 12:</span> Determination of the Relevance of a Deployment or a Service</figcaption>
</figure>
</div>
<p>To determine if an object is relevant for the automation, the operator uses the logic shown in Figure <a href="#fig:automation_relevant_parts">12</a>. If the object in question is not a deployment (or any other deployable resource, like a “Stateful Set” or “Daemon Set”) or a service, then it is not relevant for the mesh. If the object is not configured to be part of the mesh, then the automation ends here as well. The last step is to inject or reconfigure elements of the object depending on its effective type.</p>
<div id="fig:automation_process" class="fignos">
<figure>
<img src="diagrams/sequences/549c16f9df0f20e9853880283c72bf51.png" alt="Figure 13: Automated Enhancement of a Deployment and a Service" /><figcaption aria-hidden="true"><span>Figure 13:</span> Automated Enhancement of a Deployment and a Service</figcaption>
</figure>
</div>
<p>The sequence that enhances deployments and services is shown in Figure <a href="#fig:automation_process">13</a>. The operator registers a “watcher” for deployments and services with the Kubernetes API. Whenever a deployment or a service is created or modified, the operator receives a notification. Then, the operator checks if the object in question “is relevant” by checking if it should be part of the authentication mesh. This participation can be configured - in the example of Kubernetes - via annotations, labels, or any other means of configuration. If the object is relevant, the operator injects sidecars into the deployment or reconfigures the service to use the injected proxy as the target for the network communication.</p>
<p>If the automation engine encounters errors, it relies on Kubernetes to perform actions to reach a meaningful state. Since the engine runs on Kubernetes, if any operational errors occur, the application is restarted by Kubernetes. Logging is essential to find such errors. If deployments and services cannot be modified, the operator shall try again in the next reconciliation cycle.</p>
<h4 id="public-key-infrastructure">Public Key Infrastructure</h4>
<p>The role of the public key infrastructure (PKI) in the solution is to build the trust anchor in the system.</p>
<div id="fig:pki_architecture" class="fignos">
<figure>
<img src="diagrams/component/b3e90574051010286b750a731ecf502d.png" alt="Figure 14: The Relation of the Public Key Infrastructure and the System" /><figcaption aria-hidden="true"><span>Figure 14:</span> The Relation of the Public Key Infrastructure and the System</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:pki_architecture">14</a> depicts the relation of the translators and the PKI. When a translator starts, it acquires trusted key material from the PKI (for example, with a certificate signing request). This key material provides the possibility to sign the identity that is transmitted to the receiving party. The receiving translator can validate the signature of the identity and the sending party. The proxies are responsible for the communication between the instances.</p>
<div id="fig:pki_process" class="fignos">
<figure>
<img src="diagrams/sequences/d13247bc26f39bc1c40b777322ec7b76.png" alt="Figure 15: Provide Key Material to the Translator" /><figcaption aria-hidden="true"><span>Figure 15:</span> Provide Key Material to the Translator</figcaption>
</figure>
</div>
<p>The sequence in Figure <a href="#fig:pki_process">15</a> shows how the PKI is used by the translator to create key material for itself. When a translator starts, it checks if it already generated a private key and obtains the key (either by creating a new one or fetching the existing one). Then, a certificate signing request (CSR) is sent to the PKI. The PKI will then create a certificate with the CSR and return the signed certificate. The provided sequence shows one possible use case for the PKI. During future work, the PKI may also be used to secure communication between proxies with mTLS.</p>
<p>When communication happens, the proxy forwards the HTTP headers, that contain the transferred identity of the user in the DSL, to the translator. In the case of a JWT token, the transformer may now confirm the signature of the JWT token with the obtained certificate since it is signed by the same Certificate Authority (CA). Then the transformation is performed and the proxy forwards the communication to the destination.</p>
<p>To increase the security and mitigate the problem of leaking certificates, it is advised to create short-living certificates in the PKI and refresh certificates periodically.</p>
<p>If the PKI encounters illegal signing requests, it must deny them. If any other unexpected errors happen, the application should log the error and then crashes to enable Kubernetes to restart the application again.</p>
<h4 id="networking-with-a-proxy">Networking with a Proxy</h4>
<p>Networking in the proposed solution works with a combination of routing and communication proxying. The general purpose of the networking element is to manage data transport between instances of the authentication mesh and route the traffic to the source/destination.</p>
<div id="fig:networking_architecture" class="fignos">
<figure>
<img src="diagrams/component/a51cc02db654f7981ccce9f2ea27a57f.png" alt="Figure 16: Networking with an Proxy" /><figcaption aria-hidden="true"><span>Figure 16:</span> Networking with an Proxy</figcaption>
</figure>
</div>
<p>As seen in Figure <a href="#fig:networking_architecture">16</a> the proxy is the mediator between source and destination of a communication. Additionally, he proxy manages the translation of the credentials by communicating with the translator to transform the identity of the authenticated user and transmit it to the destination where it gets transformed again. Additionally, with the help of the PKI, the proxy can verify the identity of the sender via mTLS.</p>
<p>Since the authentication mesh relies on external software to take care of communication and networking, error handling is off-loaded to that specific software as well. The authentication mesh does not guarantee any connectivity between parts of the mesh. In the platform-specific example, if the configuration provided by the automation engine is faulty, Envoy will crash and log this matter to the standard output (i.e. the console). Any other errors encountered by Envoy result in their respective HTTP error messages.</p>
<h5 id="inbound-accepted-communication-for-an-application">Inbound Accepted Communication for an Application</h5>
<div id="fig:inbound_networking_process" class="fignos">
<figure>
<img src="diagrams/sequences/9e6dd351bce1bd272d919a5a1d61008b.png" alt="Figure 17: Inbound Accepted Networking Sequence" /><figcaption aria-hidden="true"><span>Figure 17:</span> Inbound Accepted Networking Sequence</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:inbound_networking_process">17</a> shows the general invocation during inbound request processing. When the proxy receives a request (in the stated example by the configured Kubernetes service), it calls the translator with the HTTP request detail. The POC is implemented with an “Envoy” proxy. Envoy allows an external service to perform “external authorization”<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> during which the external service may:</p>
<ul>
<li>Add new headers before reaching the destination</li>
<li>Overwrite headers before reaching the destination</li>
<li>Remove headers before reaching the destination</li>
<li>Add new headers before returning the result to the caller</li>
<li>Overwrite headers before returning the result to the caller</li>
</ul>
<p>The translator uses this concept to consume a specific and well-known header to read the identity of the authorized user in the DSL. The identity is then validated and transformed to the authentication credentials needed by the destination. Then, the translator instructs Envoy to set the credentials for the upstream. In the POC, this is achieved by setting the <code>Authorization</code> header to static Basic Authentication (RFC7617) credentials.</p>
<h5 id="inbound-rejected-communication-for-an-application">Inbound rejected Communication for an Application</h5>
<p>If the incoming communication contains faulty, invalid, or no identification data, the proxy blocks the communication.</p>
<div id="fig:inbound_networking_process_rejected" class="fignos">
<figure>
<img src="diagrams/sequences/c9944f2c41fc552216da1e26415a9bff.png" alt="Figure 18: Inbound Rejected Networking Sequence" /><figcaption aria-hidden="true"><span>Figure 18:</span> Inbound Rejected Networking Sequence</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:inbound_networking_process_rejected">18</a> shows the sequence when no or invalid identity data is provided. The responses of the translator are defined in <strong>RFC1945</strong> and are the HTTP response status codes <span class="citation" data-cites="RFC1945">[18]</span>. The translator distinguishes two cases:</p>
<ul>
<li>No identity data</li>
<li>Invalid identity data</li>
</ul>
<p>If no identity data is present, the translator must return <code>HTTP 401 Unauthorized</code>, the error that is used when no authorization credentials are provided. When invalid authorization credentials are provided (a false or a modified identity), the translator must return <code>HTTP 403 Forbidden</code>, which is used when credentials are provided, but they are not valid <span class="citation" data-cites="RFC1945">[18]</span>.</p>
<h5 id="outbound-communication-for-an-application">Outbound Communication for an Application</h5>
<div id="fig:outbound_networking_process" class="fignos">
<figure>
<img src="diagrams/sequences/15c6dc7ad44f5c7fb56b2089e18e93ed.png" alt="Figure 19: Outbound Networking Sequence" /><figcaption aria-hidden="true"><span>Figure 19:</span> Outbound Networking Sequence</figcaption>
</figure>
</div>
<p>In Figure <a href="#fig:outbound_networking_process">19</a> the outbound traffic flow is shown. The proxy is required to catch all outbound traffic from the source and performs the reversed process of Figure <a href="#fig:inbound_networking_process">17</a> by transforming the provided credentials from the source to generate the common format with the user identity. This identity is then inserted into the HTTP headers and sent to the destination. At the sink, the process of Figure <a href="#fig:inbound_networking_process">17</a> takes place - if the sink is part of the authentication mesh.</p>
<h4 id="the-translation-of-credentials-to-an-identity">The Translation of Credentials to an Identity</h4>
<p>The translator is responsible for transforming the identity from and to the domain-specific language (the common format). In conjunction with the PKI, the translator can verify the validity and integrity of the incoming identity.</p>
<div id="fig:translator_process" class="fignos">
<figure>
<img src="diagrams/sequences/b8cc77f1f80887b6b12a3679333a7f0d.png" alt="Figure 20: Translator Process" /><figcaption aria-hidden="true"><span>Figure 20:</span> Translator Process</figcaption>
</figure>
</div>
<p>When the translator receives a request to create the required credentials, it performs the sequence of actions as stated in Figure <a href="#fig:translator_process">20</a>. First, the proxy will forward the HTTP request data to the translator. Afterward, the translator checks if the transported identity is valid and signed by an authorized party in the authentication mesh. When the credentials are valid, they are translated according to the implementation of the translator. The proxy is then instructed with the actions to replace the transported identity with the correct credentials to access the destination.</p>
<p>The translator is the critical part of the authentication mesh. If it receives invalid credentials (e.g. an identity that has been tampered with, or just a wrong username/password combination), it must reject the request with a <code>HTTP 403 Forbidden</code> response. If no identity is provided at all, a <code>HTTP 401 Unauthorized</code> must be sent. When the translation engine encounters any unexpected error during translation of the identity (like not being able to access the secret storage, or failure of some database), it must reject the request. The translator must reject any request that cannot be transformed successfully. This error handling is used on the receiving and the sending side.</p>
<p>In the POC, the proof of integrity is not implemented, but the transformation takes place, where a “Bearer Token”<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> is used to check if the user may access the destination and then replaces the token with static Basic Authentication credentials.</p>
<h2 id="securing-the-communication-between-applications">Securing the Communication between Applications</h2>
<p>The communication between the proxies must be secured. Furthermore, the identity that is transformed over the wire must be tamper-proof. Two established formats would suffice, “SAML” and “JWT Tokens.” While both provide the possibility to hash their contents and thus secure them against modification, JWT tokens are better designed for HTTP headers. In current OIDC environments, JWT tokens are already used as access and/or identity tokens. JWT provides a secure environment with public and private claim names <span class="citation" data-cites="RFC7519">[19]</span>.</p>
<p>Other options to encode the identity:</p>
<ul>
<li>Simple JSON</li>
<li>YAML</li>
<li>XML</li>
<li>X509 Certificates</li>
<li>Concise Binary Object Representation (CBOR)</li>
<li>Any other structured format</li>
</ul>
<p>The problem with other structured formats is that tamper protection and encoding must be implemented manually. JWT tokens provide a specified way of attaching a hashed version of the complete content and therefore provide a method of validating a JWT token if it is still pristine and if the sender is trusted <span class="citation" data-cites="RFC7519">[19]</span>. If the receiving end fetched the key material from the same PKI (and therefore the same CA), it can check the certificate and the integrity of the JWT token. If the signature is correct, the JWT token has been issued by a trusted and registered instance of the authentication network.</p>
<p>X509 certificates - as defined in <strong>RFC5280</strong> <span class="citation" data-cites="RFC5280">[20]</span> - introduce another valid way of transporting data and attributes to another party. “Certificate Extensions” can be defined by “private communities” and are attached to the certificate itself <span class="citation" data-cites="RFC5280">[20]</span>.</p>
<p>While X509 certificates could be used instead of JWT to transport this data, using certificates would enforce the translator to act as intermediate CA and create new certificates for each request. From our experience, creating, extracting, and manipulating certificates, for example in C#, is not a task done lightely. Since this solution should be as easy to use as it can be, manipulating certificates in translators do not seem to be a feasible option. For the sake of simplicity and well-known usage, further work on this project will probably use JWT tokens to transmit the identity data.</p>
<h2 id="sec:poc">Implementation Proof of Concept (POC)</h2>
<p>To prove that the general idea of the solution is possible, a POC is implemented during the work of this project. The following technologies and environments build the foundation of the POC:</p>
<ul>
<li>Environment: The POC is implemented on a Kubernetes environment to enable automation and easy deployment for testing</li>
<li>“Automation”: A Kubernetes operator, written in .NET (C#) with the “Dotnet Operator SDK”<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></li>
<li>“Proxy”: Envoy proxy which gets the required configuration injected as Kubernetes ConfigMap file</li>
<li>“Translator”: A .NET (F#) application that uses the Envoy gRPC definitions to react to Envoy’s requests and poses as the external service for the external authorization</li>
<li>“Sample Application”: A solution of three applications that pose as demo case with:
<ul>
<li>“Frontend”: An ASP.NET static site application that authenticates itself against “ZITADEL”<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a></li>
<li>“Modern Service”: An ASP.NET API application that can verify an OIDC token from ZITADEL</li>
<li>“Legacy Service”: A “legacy” ASP.NET API application that is only able to verify <code>Basic Auth</code> (RFC7617, see Section <a href="#sec:basic_auth">2.6.1</a>)</li>
</ul></li>
</ul>
<p>The POC addresses the following questions:</p>
<ul>
<li>Is it possible to intercept HTTP requests to an arbitrary service</li>
<li>Is it further possible to modify the HTTP headers of the request</li>
<li>Can a sidecar service transform given credentials from one format to another</li>
<li>Can a custom operator inject the following elements:
<ul>
<li>The correct configuration for Envoy to use external authentication</li>
<li>The translator module to transform the credentials</li>
</ul></li>
</ul>
<p>Based on the results of the POC, the following further work may be possible:</p>
<ul>
<li>Specify the concrete format to transport identities</li>
<li>Implement a secure way of transporting identities with validation of the integrity</li>
<li>Provide production-ready versions for some translators and the operator</li>
<li>Integrate the solution with a service mesh</li>
<li>Further investigate the possibility of hardening the communication between services (e.g. with mTLS)</li>
</ul>
<p>For the solution to be production-ready, at least the secure communication channel between elements of the mesh as well as the DSL for the identity must be implemented. To be of use in current cloud environments, an implementation in Kubernetes can provide insights on how to develop the solution for other orchestrators than Kubernetes.</p>
<h3 id="sec:install_poc">Installation of the POC</h3>
<p>This section shows how to install the case study locally. The installation guide is also hosted on GitHub (<a href="https://github.com/WirePact/wirepact-poc" class="uri">https://github.com/WirePact/wirepact-poc</a>). The installation consists of the operator and the case study with three application parts. To access the application, Ambassador acts as API gateway.</p>
<p>To begin the installation of the POC, a Kubernetes environment is needed. On Windows and Apple devices, Docker Desktop with Kubernetes<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a> is recommended. Other environments, for example minikube<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>, work as well. The next step is to install Ambassador as API gateway with the shell script <code>./Kubernetes/case-study/install-ambassador.sh</code>. On Windows, the Subsystem for Linux or the git bash can be used to execute the shell script. Otherwise, the PowerShell can be used to execute the <code>kubectl</code> commands in the shell script one by one.</p>
<p>For the last step, the <code>Kustomize</code><a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a> executable is required. Change into the <code>Kubernetes</code> directory and run <code>kustomize build</code> to see the output of the <code>kustomization.yaml</code> file or <code>kustomize build | kubectl apply -f -</code> to build and directly apply the result to Kubernetes. This installs the operator and the case study. When everything is set up, the frontend application can be accessed via <code>https://localhost</code>, <code>https://kubernetes.docker.internal</code>, or <code>https://kubernetes.local</code> depending on the hosts config of the machine.</p>
<p>To be able to log in into the frontend application, any ZITADEL account may be used. It does not matter if the account is bound to an organization or resides in the global organization.</p>
<h3 id="case-study-for-the-poc">Case Study for the POC</h3>
<p>The demo application demonstrates the particular use case of the distributed authentication mesh. The application resides in an open-source repository on GitHub (<a href="https://github.com/WirePact/poc-showcase-app" class="uri">https://github.com/WirePact/poc-showcase-app</a>).</p>
<p>When installed in a Kubernetes cluster, a user can open (depending on the local configuration) the URL to the frontend application<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a>.</p>
<div id="fig:impl_components_showcase_app" class="fignos">
<figure>
<img src="diagrams/component/56283de2e5979940600075ebb2eec200.png" alt="Figure 21: Component Diagram of the Case Study" /><figcaption aria-hidden="true"><span>Figure 21:</span> Component Diagram of the Case Study</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:impl_components_showcase_app">21</a> gives an overview of the components in the showcase application. The system contains an ASP.NET Razor Page<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> application as the frontend, an ASP.NET API application with configured ZITADEL OIDC authentication as “modern” backend service, and another ASP.NET API application that only supports Basic Authentication as “legacy” backend. The frontend can only communicate with the modern API while the modern API can call an additional service on the legacy API.</p>
<div id="fig:seq_showcase_call" class="fignos">
<figure>
<img src="diagrams/sequences/d7be7433001a1299cf3177eee650a4bf.png" alt="Figure 22: Sequence Diagram of the Communication in the Case Study" /><figcaption aria-hidden="true"><span>Figure 22:</span> Sequence Diagram of the Communication in the Case Study</figcaption>
</figure>
</div>
<p>In Figure <a href="#fig:seq_showcase_call">22</a>, we show the process of a user call in the demo application. The user opens the web application and authenticates himself with ZITADEL. After that, the user is presented with the application and can click the “Call API” button. The frontend application calls the modern backend API with the access token from ZITADEL and asks for customer and order data. The customer data is present on the modern API, therefore it is directly returned. To fetch the order data, the modern service relies on a legacy application which is only capable of Basic Authentication.</p>
<p>Depending on the configuration (i.e. the environment variable <code>USE_WIREPACT</code>), the modern service will call the legacy application with either transformed basic authentication credentials (when <code>USE_WIREPACT=false</code>) or with the ZITADEL access token (<code>USE_WIREPACT=true</code>). Either way, the legacy API receives basic authentication credentials in the form of <code>&lt;username&gt;:&lt;password&gt;</code> and returns the data.</p>
<p>To install and run the case study without any interference of the operator or the rest of the solution, follow the installation guide in the readme on <a href="https://github.com/WirePact/poc-showcase-app" class="uri">https://github.com/WirePact/poc-showcase-app</a>. To install and use the whole POC, following the instructions in Section <a href="#sec:install_poc">4.7.1</a> will install the operator and the case study.</p>
<h3 id="automation-engine-for-applications">Automation Engine for Applications</h3>
<p>As explained in Section <a href="#sec:abstract_architecture">4.5.2</a>, the automation engine is generally optional. If omitted, the user is responsible for configuring the proxy and the translator. In the POC, the automation engine is a Kubernetes operator written with the .NET SDK in C#. The source of the POC operator resides on GitHub: <a href="https://github.com/WirePact/poc-operator" class="uri">https://github.com/WirePact/poc-operator</a>. The operator (automated and customized management of resources in Kubernetes, see Section <a href="#sec:kubernetes_operator">2.3</a>) intercepts events for <code>Deployments</code> and <code>Services</code>. To update services and deployments in the POC, an annotation (key-value storage in the metadata of an object in Kubernetes) is used. In future work, the operator may react to Custom Resource Definitions (CRD) as well.</p>
<div id="fig:poc_operator_events" class="fignos">
<figure>
<img src="diagrams/states/f6212c1b5b849eed502cbb7b10115a14.png" alt="Figure 23: Activity Model for Kubernetes Resources in the Automation Engine" /><figcaption aria-hidden="true"><span>Figure 23:</span> Activity Model for Kubernetes Resources in the Automation Engine</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:poc_operator_events">23</a> gives an overview of the process that an event of the Kubernetes API completes. When the operator receives a notification by Kubernetes that a service or a deployment was created or modified, the operator determines the type and uses the specific controller to reconcile the resource. If the entity is a deployment/service and is relevant for the authentication mesh, the operator will modify the deployment/service.</p>
<div id="fig:poc_operator_deployment" class="fignos">
<figure>
<img src="diagrams/states/74c7d2e051d88f19f56539db2924ac3a.png" alt="Figure 24: Automated Configuration of a Kubernetes Deployment in the POC" /><figcaption aria-hidden="true"><span>Figure 24:</span> Automated Configuration of a Kubernetes Deployment in the POC</figcaption>
</figure>
</div>
<p>In the case of a deployment, Figure <a href="#fig:poc_operator_deployment">24</a> shows the process for the management-event of the deployment. The first step of the operator is to determine if the entity is relevant for the authentication mesh. If the deployment contains the annotation <code>ch.wirepact/port</code> in its metadata, it is automatically part of the mesh. If the deployment is already configured, further reconfiguration is skipped. If not, the operator fetches the already configured ports of the deployment, and generates two additional ports. One port is used for the Envoy sidecar while the other is configured for the translator sidecar. The next step is to generate and store the Envoy configuration in a Kubernetes <code>ConfigMap</code>. Last, the sidecars are injected into the deployment configuration and the Kubernetes client stores the modified manifest.</p>
<div id="fig:poc_operator_service" class="fignos">
<figure>
<img src="diagrams/states/ae44bce0b71a90fb340fe0a690116181.png" alt="Figure 25: Automated Configuration of a Kubernetes Service in the POC" /><figcaption aria-hidden="true"><span>Figure 25:</span> Automated Configuration of a Kubernetes Service in the POC</figcaption>
</figure>
</div>
<p>When reconciling a service, Figure <a href="#fig:poc_operator_service">25</a> shows the activities of the operator during the reconciliation. The service counts as relevant if the annotation <code>ch.wirepact/deployment</code> is present in the metadata of the service. The value of this annotation stores the deployment object to which the service should point. The operator reads the annotations on the service to determine the port in question and searches for the port in its manifest. The port will receive a new “target port” that points to the Envoy port of the deployment. Last, the Kubernetes client will store the changed service.</p>
<h3 id="network-and-routing-proxy-for-communication">Network and Routing Proxy for Communication</h3>
<p>In the POC, the proxy sidecar is an Envoy proxy with its configuration injected by the automation engine. The operator injects the sidecar whenever a <code>Deployment</code> is created or updated via the Kubernetes API. A <code>ConfigMap</code> with the envoy configuration is created during reconciliation.</p>
<p>Two parts of the envoy configuration are crucial. First, the <code>filter_chain</code> of the inbound traffic listener contains a list of <code>http_filters</code>. Within this list of filters, the external authorization filter is added to force Envoy to check if a request is allowed or not:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... more config</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">http_filters</span><span class="kw">:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> envoy.filters.http.ext_authz</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">typed_config</span><span class="kw">:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">&#39;@type&#39;</span><span class="kw">:</span><span class="at"> type.googleapis.com/</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">        envoy.extensions.filters.http.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">        ext_authz.v3.ExtAuthz</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">transport_api_version</span><span class="kw">:</span><span class="at"> v3</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">grpc_service</span><span class="kw">:</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">envoy_grpc</span><span class="kw">:</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cluster_name</span><span class="kw">:</span><span class="at"> auth_translator</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 1s</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">include_peer_certificate</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> envoy.filters.http.router</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ... more config</span></span></code></pre></div>
<p>Second, via the configured name (<code>auth_translator</code>), the external authorization service must be added to the <code>clusters</code> list:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ... more config</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> auth_translator</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">connect_timeout</span><span class="kw">:</span><span class="at"> 0.25s</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> STATIC</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">typed_extension_protocol_options</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span class="kw">:</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">&#39;@type&#39;</span><span class="kw">:</span><span class="at"> type.googleapis.com/</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">        envoy.extensions.upstreams.http.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">        v3.HttpProtocolOptions</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">explicit_http_config</span><span class="kw">:</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">http2_protocol_options</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">load_assignment</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cluster_name</span><span class="kw">:</span><span class="at"> auth_translator</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">endpoints</span><span class="kw">:</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">lb_endpoints</span><span class="kw">:</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">endpoint</span><span class="kw">:</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">address</span><span class="kw">:</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">socket_address</span><span class="kw">:</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">address</span><span class="kw">:</span><span class="at"> </span><span class="fl">127.0.0.1</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">port_value</span><span class="kw">:</span><span class="at"> &lt;&lt;PORT_VALUE&gt;&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ... more config</span></span></code></pre></div>
<p>This configures Envoy to find the external authorization service on the local loopback IP on the configured port. Since the transformer uses gRPC (<code>grpc_service: envoy_grpc: ...</code> in the filter config), http2 must be enabled for the communication. In a productive environment, timeouts should be set accordingly.</p>
<h3 id="sec:poc_translator">Translator</h3>
<p>The translator is the part of the POC that performs the modification of HTTP headers per request. Since the intermediate DSL is not implemented in the POC, the translator converts an access token to static basic authentication credentials. If any error occurs or the translator call exceeds ten seconds, Envoy returns a HTTP 403 Forbidden message by default. The source code is on GitHub: <a href="https://github.com/WirePact/poc-demo-translator" class="uri">https://github.com/WirePact/poc-demo-translator</a>.</p>
<div id="fig:poc_translator_403" class="fignos">
<figure>
<img src="diagrams/sequences/c6784e01387704df2ec9b225731f55d6.png" alt="Figure 26: Communication with an Invalid Access Token" /><figcaption aria-hidden="true"><span>Figure 26:</span> Communication with an Invalid Access Token</figcaption>
</figure>
</div>
<p>Figure <a href="#fig:poc_translator_403">26</a> shows the sequence for an access token that is not valid. Envoy forwards the HTTP headers to the translator that extracts the <code>Authorization</code> header. If it is not a <code>Bearer</code> access token, or if the validation with ZITADEL fails (if the token is invalid or has expired), the translator returns an <code>Unauthorized</code> (HTTP 401) or <code>Forbidden</code> (HTTP 403) response depending on the status. The <code>Unauthorized</code> status is returned when no access token is provided (i.e. the HTTP header is missing). <code>Forbidden</code> is used if the token is invalid. In either case, Envoy will return the returned status code to the caller and terminates the request. The destination application does not receive any communication or notification about this event.</p>
<div id="fig:poc_translator_200" class="fignos">
<figure>
<img src="diagrams/sequences/8f339fcb9c6d1450715f4e3ca9d55f81.png" alt="Figure 27: Communication with a Valid Access Token" /><figcaption aria-hidden="true"><span>Figure 27:</span> Communication with a Valid Access Token</figcaption>
</figure>
</div>
<p>In contrast to Figure <a href="#fig:poc_translator_403">26</a>, the sequence in Figure <a href="#fig:poc_translator_200">27</a> shows the success path of a communication. If the given access token is valid, the translator fetches the static Basic Authentication credentials (i.e. username and password) from the secret storage. The secret storage in the POC is a simple Kubernetes Secret. The received credentials are then transformed in the correct encoded Basic Authentication format (as described in RFC7617). The translator returns an instruction set for Envoy to process the HTTP request. Envoy executes the instructions and forwards the call to the destination and returns the response - if any.</p>
<h4 id="instructions-for-rejected-request">Instructions for Rejected Request</h4>
<p>When the translator decides that the request is unauthorized or forbidden, it returns a <code>DeniedResponse</code> to Envoy. The response is encoded in a binary “Protocol Buffers”<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a> format, but a JSON example would be:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;deniedResponse&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="dv">403</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;body&quot;</span><span class="fu">:</span> <span class="st">&quot;No valid Authorization provided&quot;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>There are additional fields encoded in the message, but the example above shows the essential parts of the denied response.</p>
<h4 id="instructions-for-accepted-request">Instructions for Accepted Request</h4>
<p>In contrast to the rejected response instructions, an accepting response may include modifications for HTTP headers. It is possible to add new, modify, and remove headers from the request for the upstream (i.e. the destination of the request), as well as adding additional or modifying headers for the downstream (i.e. the source of the request when the result is returned). Such a response that replaces the <code>Authorization</code> header with the basic credentials is:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;okResponse&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;headers&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;header&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;Authorization&quot;</span><span class="fu">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;Basic Q2hyaXN0b3BoQnVlaGxlcjpTdXBlclNlY3VyZQ==&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>In the response above, if an <code>Authorization</code> header already exists, it is replaced. Otherwise, the value is added. In the case of the distributed authentication mesh, this technique may be used to consume the user identity (i.e. remove a custom header) and add the specific authentication credentials for the upstream.</p>
<h1 id="sec:evaluation">Evaluation</h1>
<p>This section evaluates the concept and the architecture of Section <a href="#sec:solution">4</a>. The main goal is to show that the proposed solution can improve the current situation and does not introduce security issues when used. Since the architecture is only conceptional, the evaluation is done in a theoretical manner.</p>
<h2 id="architecture-against-requirements">Architecture against Requirements</h2>
<p>To show that the architecture of the distributed authentication mesh does improve the developer experience and the current situation with legacy or third-party software, we compare the architecture against the non-functional requirements in Table <a href="#tbl:non-functional-requirements">3</a>.</p>
<h3 id="nfr-1-improve-security">NFR 1: Improve Security</h3>
<blockquote>
<p>NFR 1: First and foremost, the solution must not be less secure than current solutions.</p>
</blockquote>
<p>Without the distributed authentication mesh, credentials like access tokens or basic authentication credentials are transmitted in the HTTP headers. This is a well-known way of authorizing requests <span class="citation" data-cites="RFC1945">[18]</span>. If the current standard is regarded “secure” - not judging by the authorization scheme - then the mesh is secure as well. It even improves security by hiding the original credentials.</p>
<p>In the POC, the credentials are still transmitted. The POC is responsible to prove that modifying HTTP headers during a request is possible. Securing the implementation of the concept is not part of this project.</p>
<h3 id="nfr-2-secure-implementation">NFR 2: Secure implementation</h3>
<blockquote>
<p>NFR 2: The solution must adhere to current best practices and security mechanisms. Furthermore, it must be implemented according to the standards of the practice to mitigate security issues as stated in the OWASP Top Ten (https://owasp.org/www-project-top-ten).</p>
</blockquote>
<p>The following list shows the OWASP top ten security issues with the comparison to the architecture:</p>
<ol type="1">
<li>Injection: The distributed authentication mesh does not use any database or LDAP features. Thus, there is no attack vector for an injection attack.</li>
<li>Broken Authentication<a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a>: The mesh does not implement a security scheme by itself. The only part that can be targeted by broken authentication attacks is the transformer. Developers of each translator must adhere to the current standards to mitigate this problem.</li>
<li>Sensitive Data Exposure: The transmitted user identity must not include sensitive data. Sensitive data, such as financial or healthcare data is not part of a user identity and not needed for the mesh. Data, such as the user id or the name of a user, may be transmitted.</li>
<li>XML External Entities: The mesh does not use XML.</li>
<li>Brocken Access Control: The mesh only provides valid credentials for the target system. It is not responsible for the authorization and enforcement of rules. The application that uses the mesh is responsible to enforce authorization rules.</li>
<li>Security Misconfiguration: The mesh does not directly influence used authentication schemes. The identity of the user is transmitted via HTTP headers, which are consumed on the receiving side of the communication. Each translator is responsible for creating the appropriate HTTP headers for its destination.</li>
<li>Cross-Site Scripting (XSS): The mesh is not part of any public-facing application. No code gets executed. Therefore, XSS is not possible.</li>
<li>Insecure Deserialization: Under the assumption that JWT is used to transmit the user identity between participating elements, this flaw is negated. The validation and deserialization of JSON does not execute any code since JSON cannot transmit executable data. The translator must not execute any data it receives from the JWT.</li>
<li>Using Components with Known Vulnerabilities: This may be an issue if developers of translators do not update their software. The translator is the “moving part” of the mesh, which can be implemented by other developers as well. Developers must update their translators to eliminate this issue.</li>
<li>Insufficient Logging &amp; Monitoring: This issue cannot be validated based on the architecture of the mesh. Since there is no production-ready implementation, logging is a part of the future work.</li>
</ol>
<p>As the list above shows, the architecture does eliminate or out-source the top ten OWASP issues. Translators must be implemented with special care to adhere to the OWASP top ten.</p>
<h3 id="nfr-3-generic-usage">NFR 3: Generic Usage</h3>
<blockquote>
<p>NFR 3: The concept of the solution is applicable to cluster orchestration software other than Kubernetes. The architecture provides a general way of solving the stated problem instead of giving a proprietary solution for one vendor. The concept should even be realizable for non-orchestration platforms like a Windows operating system.</p>
</blockquote>
<p>The architecture in Section <a href="#sec:abstract_architecture">4.5.2</a> is generic. All components may be implemented on any platform and with any programming language of choice. The automation engine is optional so that the proposed concept may be implemented as a macOS or Windows software. There is no special requirement for any part of the mesh that ties the solution to a specific vendor. Section <a href="#sec:specific_architecture">4.5.3</a> shows an example of the architecture in the context of Kubernetes.</p>
<h3 id="nfr-4-performance-impact">NFR 4: Performance Impact</h3>
<blockquote>
<p>NFR 4: The translation of the credentials should not extensively impact the timeframe of an arbitrary request. In production mode, the additional time to check and transform the credentials should not exceed 100ms. This is a general recommendation and some authentication mechanism may exceed the stated 100ms.</p>
</blockquote>
<p>The architecture does not give hints about the effective performance impact. This generally depends on the used authentication scheme and the implementation of the transformer. Each transformer is responsible to achieve this goal. The solution is - theoretically - not limited in execution time, but to function as a production-ready solution, it must not impact the execution time of requests significantly.</p>
<h3 id="nfr-5-modularity">NFR 5: Modularity</h3>
<blockquote>
<p>NFR 5: The solution is modular. It is extensible with additional “translators,” that provide the means of transforming the given credentials to other target formats.</p>
</blockquote>
<p>The architecture shows that the translator is a component that is orchestrated by the automation engine. The translators should target one specific authentication scheme and can be implemented in any language or framework. They must only adhere to the principles of the mesh. It is not defined how the communication between the proxy and the translator takes place. In the POC, Envoy (as the proxy) has a well-defined gRPC definition for such communication. Further work may contain the definition of translators for the automation engine. Using Envoy and the gRPC definition is a feasible option to implement a production-ready version of the mesh when using a cloud environment.</p>
<h3 id="nfr-6-interoperability">NFR 6: Interoperability</h3>
<blockquote>
<p>NFR 6: The solution may run with or without a service mesh. It is a goal that the solution can run without a service mesh to reduce the overall complexity, but if a service mesh is already in place, the solution must be able to work with the provided infrastructure.</p>
</blockquote>
<p>The shown architecture in Section <a href="#sec:abstract_architecture">4.5.2</a> does not interfere with a service mesh. If a service mesh is already deployed on a cloud environment, the automation engine must configure/reuse the parts that are already given by the service mesh.</p>
<h3 id="nfr-7-scalability">NFR 7: Scalability</h3>
<blockquote>
<p>NFR 7: The architecture must be scalable. The provided software must be able to scale according to the business needs of the overall system.</p>
</blockquote>
<p>Section <a href="#sec:specific_architecture">4.5.3</a> shows that the automation engine does enhance Kubernetes pods. A pod is one unit of deployment. When a pod is scaled by Kubernetes, all containers in the pod do scale as well. Since all parts of the mesh are complete packages, they do scale with the pod.</p>
<h3 id="nfr-8-separation-of-concerns">NFR 8: Separation of Concerns</h3>
<blockquote>
<p>NFR 8: Each translator should only handle one authentication scheme to ensure the separation of concerns and scalability of the whole solution.</p>
</blockquote>
<p>The architecture does not define the effective implementation of the translators. Each translator can be written in any language or framework. The responsibility to adhere to the separation of concerns is handed over to the developers of translators.</p>
<h3 id="nfr-9-no-data-transfer">NFR 9: No Data-Transfer</h3>
<blockquote>
<p>NFR 9: The solution depends on external software for data transmission. The solution must not interfere with the data plane. Error handling of the data plane is handled by the external application.</p>
</blockquote>
<p>The proxy and translator only modify HTTP headers. The effective transmission of the data between the parties is not part of the authentication mesh. As such, error handling for the transmission is also out-sourced to the used proxy software.</p>
<h3 id="nfr-10-error-handling">NFR 10: Error Handling</h3>
<blockquote>
<p>NFR 10: The solution handles errors in the translation and the automation engine according to the architectural description.</p>
</blockquote>
<p>All parts of the authentication mesh rely on external software, with the exception of translators. As stated above, error handling for the transmission of data is not needed since this is done by a proxy (Envoy in the POC). All other components are not part of the critical path. Section <a href="#sec:poc_translator">4.7.5</a> states that in the case of a timeout, error, or invalid data, the request must be blocked by the translator. Only valid requests must be let through to the destination.</p>
<h2 id="prevent-leakage-of-credentials">Prevent Leakage of Credentials</h2>
<p>As stated in Section <a href="#sec:deficiencies">3.3</a>, when applications with diverging authentication schemes communicate with each other, they must transmit credentials to the destination. Otherwise, it would not be possible to authenticate a user in each system.</p>
<p>The distributed authentication mesh replaces the need of effective credentials in communication with federated identity. Similar to SAML (Section <a href="#sec:saml">4.3.1</a>), an encoded identity is transmitted with the request instead of user credentials such as passwords or access tokens. This identity is then translated to effective credentials in the translator and ultimately forwarded to the target application.</p>
<h2 id="improve-developer-and-user-experience">Improve Developer and User Experience</h2>
<p>Another identified problem in Section <a href="#sec:deficiencies">3.3</a> is the introduction of code changes when the use case for the authentication mesh arises. To enable “modern software” to talk with “legacy software” (or third-party software), most likely the modern software will implement the translation logic. This may introduce bugs and does not scale when the service landscape grows.</p>
<p>The proposed concept enables developers to declaratively (via configuration) transform such credentials between applications. When used in a cloud environment, the automation engine can take care of all moving parts. With the solution in place, a developer is only required to configure the application as part of the mesh and the automation engine will inject the needed proxy and translators. After the automation step has taken place, the application is enhanced with additional authentication schemes without implementing the effective translation.</p>
<h1 id="conclusions-and-outlook">Conclusions and Outlook</h1>
<p>This report showed a potential solution to the problem of dynamic credential transformation in systems with diverging authentication mechanisms. In Section <a href="#sec:introduction">1</a>, a brief overview stated the problem and described the goal of the project.</p>
<p>Section <a href="#sec:definitions">2</a> defined the scope of the project and explained various technologies and terms like “Kubernetes,” “Operator Pattern,” and “Sidecar Pattern.” Additionally, Section <a href="#sec:definitions">2</a> introduced vital information about authentication, authorization, and security standards required for the general understanding of this report.</p>
<p>Section <a href="#sec:state_of_the_art">3</a> gave an overview of the current state of the art and the current problems. The maintainability of implementing multiple authentication schemes and the leakage of user credentials (like access tokens) onto the wire were identified as core problems.</p>
<p>To solve the stated problems in Section <a href="#sec:state_of_the_art">3</a>, a conceptional architecture was proposed in Section <a href="#sec:solution">4</a>. To show the architecture within a practical environment, Section <a href="#sec:solution">4</a> also gave a platform-specific example of the archtecture in Kubernetes. The conceptual idea of the distributed authentication mesh introduced a solution to the issues of diverging authentication schemes and leakage of credentials. When using a proxy component to intercept traffic from and to a service, a “translator” component can modify the HTTP headers of the requests. This removed the requirement of transmitting sensible credentials over the wire, which fixed the problem of leaking credentials. The translator transforms outgoing credentials (for example an access token) to a common format. On the receiving side, the proxy intercepts the request and the translator converts the common format into the authentication scheme fitting the destination service. With the same procedure, the issue of implementing multiple authentication schemes in an application was addressed as well. It is possible to have multiple transformers and therefore serve a multitude of authentication mechanisms without introducing code changes to the applications.</p>
<p>The idea of the distributed authentication mesh came close to the concept of SAML (Security Assertion Markup Language). While SAML provides a federated identity, it requires the participating services to implement the SAML protocol as well, the authentication mesh removes this requirement. The shown concept improves the developer experience by allowing dynamic credential transformation.</p>
<p>To validate if the concept is feasible, the proof of concept in Section <a href="#sec:solution">4</a> has shown that it is possible to modify HTTP headers in-flight and therefore the core concept of the architecture is generally possible. Furthermore, Section <a href="#sec:evaluation">5</a> checked if the given requirements and goals/non-goals were achieved with the proposed architecture. The evaluation shows that the solution is able to enhance general security by preventing the leakage of credentials.</p>
<p>As complementation to the main delivery of this project - the concept of the distributed authentication mesh - teaching material was created that can be found in Appendix A. It targets the topic of “Kubernetes Operators and how to create them.” This material may be used to introduce people to the operator pattern and helps to create a custom operator with a SDK.</p>
<p>The goal of the future work is to provide a federated authentication with secured communication without leakage of credentials out of the trust zone. The concept of the distributed authentication mesh from this work will be complemented with definitions to configure the mesh and the analysis, definition, and implementation of a common identity format for the transmission. The concepts of the mesh will be used to implement a production-ready version of the authentication mesh in Kubernetes.</p>
<p>With the implementation of the authentication mesh in Kubernetes, various use cases can be covered. As an example, in the finance sector, banking APIs tend to use varying authentication schemes and do not wish to change their applications. The authentication mesh improves this situation by covering the dynamic transformation of credentials to the respective format. The concept of the distributed authentication mesh can be implemented as an application that runs directly on an operating system to provide a federated identity into a company network. It negates the requirement of implementing technologies like SAML in each application that is accessed in this company network.</p>
<p>When regarding the current trends, applications will become more heterogeneous in the future. Authentication protocols come and go and it is not likely that one particular standard will solve all issues. The concepts of this project contribute to sustainability and reusability in the security world.</p>
<h1 class="unnumbered" id="bibliography">Bibliography</h1>
<div id="refs" class="references csl-bib-body" role="doc-bibliography">
<div id="ref-github:kubernetesWebsite" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">CNCF: Kubernetes website, (2021).</div>
</div>
<div id="ref-cc:CCBY4.0" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">Creative Commons: Attribution 4.0 international (CC BY 4.0), (2021).</div>
</div>
<div id="ref-RFC6902" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">3. </div><div class="csl-right-inline">Bryan, P., Nottingham, M.: Javascript object notation (<span>JSON</span>) patch. Internet Engineering Task Force <span>IETF</span> (2013).</div>
</div>
<div id="ref-dobies:KubernetesOperators" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">4. </div><div class="csl-right-inline">Dobies, J., Wood, J.: Kubernetes operators: Automating the container orchestration platform. " O’Reilly Media, Inc." (2020).</div>
</div>
<div id="ref-burns:DesignPatternsForContainerSystems" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">5. </div><div class="csl-right-inline">Burns, B., Oppenheimer, D.: Design patterns for container-based distributed systems. In: 8th <span>USENIX</span> workshop on hot topics in cloud computing (HotCloud 16). <span>USENIX</span> Association, Denver, CO (2016).</div>
</div>
<div id="ref-li:ServiceMesh" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">6. </div><div class="csl-right-inline">Li, W., Lemieux, Y., Gao, J., Zhao, Z., Han, Y.: Service mesh: Challenges, state of the art, and future research opportunities. In: 2019 IEEE international conference on service-oriented system engineering (SOSE). pp. 122–1225 (2019). <a href="https://doi.org/10.1109/SOSE.2019.00026">https://doi.org/10.1109/SOSE.2019.00026</a>.</div>
</div>
<div id="ref-montesi:CircuitBreakers" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">7. </div><div class="csl-right-inline">Montesi, F., Weber, J.: Circuit breakers, discovery, and <span>API</span> gateways in microservices. CoRR. abs/1609.05830, (2016).</div>
</div>
<div id="ref-RFC7617" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">8. </div><div class="csl-right-inline">Reschke, J.: The ’basic’ <span>HTTP</span> authentication scheme. Internet Engineering Task Force <span>IETF</span> (2015).</div>
</div>
<div id="ref-RFC6749" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">9. </div><div class="csl-right-inline">Hardt, D., others: The <span>OAuth</span> 2.0 authorization framework. Internet Engineering Task Force <span>IETF</span> (2012).</div>
</div>
<div id="ref-spec:OIDC" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">10. </div><div class="csl-right-inline">Sakimura, N., Bradley, J., Jones, M., De Medeiros, B., Mortimore, C.: Openid connect core 1.0. The <span>OpenID</span> Foundation <span>OIDF</span> (2014).</div>
</div>
<div id="ref-rose:zero-trust" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">11. </div><div class="csl-right-inline">Rose, S., Borchert, O., Mitchell, S., Connelly, S.: Zero trust architecture. National Institute of Standards; Technology (2019).</div>
</div>
<div id="ref-kratzke:CloudNativeApplications" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">12. </div><div class="csl-right-inline">Kratzke, N., Peinl, R.: ClouNS - a cloud-native application reference model for enterprise architects. In: 2016 IEEE 20th international enterprise distributed object computing workshop (EDOCW). pp. 1–10 (2016). <a href="https://doi.org/10.1109/EDOCW.2016.7584353">https://doi.org/10.1109/EDOCW.2016.7584353</a>.</div>
</div>
<div id="ref-istio:website:mtls" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">13. </div><div class="csl-right-inline">Istio Authors: Mutual TLS migration, <a href="https://istio.io/latest/docs/tasks/security/authentication/mtls-migration/">https://istio.io/latest/docs/tasks/security/authentication/mtls-migration/</a>, (2021).</div>
</div>
<div id="ref-istio:website:custom-authz" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">14. </div><div class="csl-right-inline">Istio Authors: External authorization, <a href="https://istio.io/latest/docs/tasks/security/authorization/authz-custom/">https://istio.io/latest/docs/tasks/security/authorization/authz-custom/</a>, (2021).</div>
</div>
<div id="ref-nginx:website:ext-authz" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">15. </div><div class="csl-right-inline">F5 Inc. Authors: Authentication based on subrequest result, <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/">https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/</a>, (2021).</div>
</div>
<div id="ref-naik:SAMLandFIdM" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">16. </div><div class="csl-right-inline">Naik, N., Jenkins, P.: Securing digital identities in the cloud by selecting an apposite federated identity management from <span>SAML</span>, <span>OAuth</span> and <span>OpenID</span> connect. In: 2017 11th international conference on research challenges in information science (RCIS). pp. 163–174 (2017). <a href="https://doi.org/10.1109/RCIS.2017.7956534">https://doi.org/10.1109/RCIS.2017.7956534</a>.</div>
</div>
<div id="ref-curbera:SOAP-and-WSDL" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">17. </div><div class="csl-right-inline">Curbera, F., Duftler, M., Khalaf, R., Nagy, W., Mukhi, N., Weerawarana, S.: Unraveling the web services web: An introduction to <span>SOAP</span>, <span>WSDL</span>, and <span>UDDI</span>. <span>IEEE</span> Internet Computing. 6, 86–93 (2002). <a href="https://doi.org/10.1109/4236.991449">https://doi.org/10.1109/4236.991449</a>.</div>
</div>
<div id="ref-RFC1945" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">18. </div><div class="csl-right-inline">Nielsen, H., Fielding, R.T., Berners-Lee, T.: <span>Hypertext Transfer Protocol – HTTP/1.0</span>. RFC 1945; RFC Editor (1996). <a href="https://doi.org/10.17487/RFC1945">https://doi.org/10.17487/RFC1945</a>.</div>
</div>
<div id="ref-RFC7519" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">19. </div><div class="csl-right-inline">Jones, M.B., Bradley, John, Sakimura, N.: <span>JSON</span> web token (<span>JWT</span>). Internet Engineering Task Force <span>IETF</span> (2015).</div>
</div>
<div id="ref-RFC5280" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">20. </div><div class="csl-right-inline">Cooper, D., Boeyen, S., Santesson, S., Polk, T., Housley, R., Farrell, S.: <span class="nocase">Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</span>. Internet Engineering Task Force <span>IETF</span> (2008). <a href="https://doi.org/10.17487/RFC5280">https://doi.org/10.17487/RFC5280</a>.</div>
</div>
</div>
<h1 class="unnumbered" id="sec:teaching-material">Appendix A: Teaching Material for Kubernetes Operators</h1>
<h2 id="motivation">Motivation</h2>
<p>The usefulness of Kubernetes Operators shows as there exists a variety of them. For example, the Prometheus Operator<a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a> which manages instances of Prometheus<a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a> in Kubernetes. A non-exhaustive list of operators can be found on <a href="https://operatorhub.io/">https://operatorhub.io</a>. An operator is not required to perform only one task.</p>
<p>Since operators are an elegant tool to extend the capabilities of Kubernetes, developers may want to know how to create a custom operator. This material gives an overview of the operator pattern and a description of how operators work. As an exercise, a custom operator must be written with the help of an SDK. The solution to the custom operator is implemented with C# and the .NET operator SDK “KubeOps”<a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a>.</p>
<h2 id="learning-objectives">Learning Objectives</h2>
<p>The operator pattern is well defined <span class="citation" data-cites="dobies:KubernetesOperators">[4]</span>. To be able to implement a custom operator, the building blocks and concepts of the internal elements of an operator must be known. An SDK helps to create an operator, but when the operator gets more complex, it may be vital to know how operators work. Therefore, this material shows how an operator works and how one can be built.</p>
<p>To summarize the learning objectives:</p>
<ul>
<li>One can explain the operator pattern with own words</li>
<li>One can explain the parts of an operator with own words</li>
<li>One can build a custom operator with an SDK</li>
</ul>
<h2 id="kubernetes-operators-and-their-use">Kubernetes Operators and their Use</h2>
<h3 id="what-is-an-operator">What is an Operator?</h3>
<p>An operator in Kubernetes is an extension to the Kubernetes API itself. A custom operator typically manages the whole lifecycle of an application <span class="citation" data-cites="dobies:KubernetesOperators">[4]</span>.</p>
<div id="fig:teach_op_loop" class="fignos">
<figure>
<img src="images/teaching_material/reconciliation_loop.png" alt="Figure 28: Kubernetes Operator Reconciliation Loop" /><figcaption aria-hidden="true"><span>Figure 28:</span> Kubernetes Operator Reconciliation Loop</figcaption>
</figure>
</div>
<p>To describe the “reconciliation loop” of an operator, we have a look at Figure <a href="#fig:teach_op_loop">28</a>. The reconciliation loop is the constant observation of the current state. When the current state diverges from the desired state, adjustments must be made to achieve the current state again. This loop is used by the Kubernetes API itself. As an example, if a user creates a deployment in Kubernetes, the API stores the deployment as the new desired state. The reconciliation loop checks if the deployment exists, and if it does not, it creates the deployment to reach the desired state.</p>
<div id="fig:teach_op_pattern" class="fignos">
<figure>
<img src="images/teaching_material/operator_pattern.png" alt="Figure 29: Kubernetes Operator Pattern" /><figcaption aria-hidden="true"><span>Figure 29:</span> Kubernetes Operator Pattern</figcaption>
</figure>
</div>
<p>The operator pattern uses the reconciliation loop to manage a custom application or a custom use case. The pattern is shown in Figure <a href="#fig:teach_op_pattern">29</a>. When a user modifies resources (be it custom resources or predefined ones), the API stores the resources as the new desired state. The operator gets notified by the API and can adjust elements in Kubernetes.</p>
<p>The operator pattern can be used to manage whole applications, for example Prometheus or PostgreSQL databases. Another use case of an operator could include injecting logging collectors into each deployment in the cloud environment.</p>
<h3 id="how-do-operators-work">How do Operators work?</h3>
<p>The following objects exist in or around an operator:</p>
<ul>
<li><strong>Watcher</strong><a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a>: The operator registers one or multiple watchers with the Kubernetes API. This enables the operator to receive events when a watched resource gets modified. A watcher can be namespaced or global and can watch one type of resource (e.g. Depoyments, Services, or a custom resource).</li>
<li><strong>Event</strong>[<a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes" class="uri">https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes</a>]: Events are the notification of the Kubernetes API that a watcher receives. There exist three relevant types of events:
<ul>
<li><em>Added</em>: When a resource gets added to the watcher. This event is fired for each resource of the watched type when the watcher is registered.</li>
<li><em>Modified</em>: When a resource that is already being watched gets modified.</li>
<li><em>Deleted</em>: When a watched resource is removed from Kubernetes and the watcher.</li>
</ul></li>
<li><strong>Custom Resource Definition</strong><a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup>30</sup></a>: A CRD is the definition of a custom resource in Kubernetes. There exist resource definitions for all standard resources like deployments and services. A CRD enables developers to create custom resources which can be reconciled by an operator.</li>
<li><strong>Controller</strong><a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup>31</sup></a>: Controllers are elements in an operator that reconcile a specific CRD/resource. An operator can contain multiple controllers and therefore manage multiple CRDs. A controller typically contains application logic to react to the events of the Kubernetes API.</li>
<li><strong>Finalizer</strong><a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup>32</sup></a>: A finalizer is a part of an operator that enables asynchronous deletion processes in Kubernetes. When a resource contains finalizers in its metadata, the API will mark the resource as in pending deletion. An operator may react to this state and can perform additional tasks, such as deleting a database or external resources. The operator must then remove its finalizer entry. When all finalizers are removed, the resource is deleted. Otherwise, it will remain in the pending deletion state.</li>
<li><strong>Mutation Webhook</strong><a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a>: A mutator (or mutation webhook) is an HTTP endpoint of an operator. The endpoint will be called whenever a watched resource type is created/updated/deleted. A mutator may return an empty response to acknowledge the creation/modification/deletion of the resource or it can patch the resource before the effective action is executed. The patch must be in the form of a JSON Patch, as defined in <strong>RFC6902</strong> <span class="citation" data-cites="RFC6902">[3]</span>. As an example, one could create a profanity filter and remove “bad” usernames from resources. Mutators are <strong>called in series</strong> by the Kubernetes API.</li>
<li><strong>Validation Webhook</strong><a href="#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup>34</sup></a>: In contrast to a mutation webhook, a validator (or validation webhook) may only accept or reject a resource. If multiple validators are registered for a certain type, they will be <strong>called in parallel</strong> by the Kubernetes API.</li>
</ul>
<div id="fig:teach_kubernetes_operator_workflow" class="fignos">
<figure>
<img src="diagrams/sequences/c28fd7ec0678a131801e6ddf95a34c7e.png" alt="Figure 30: Kubernetes Operator Workflow" /><figcaption aria-hidden="true"><span>Figure 30:</span> Kubernetes Operator Workflow</figcaption>
</figure>
</div>
<p>To specify the general workflow in Figure <a href="#fig:teach_op_pattern">29</a> in more detail, Figure <a href="#fig:teach_kubernetes_operator_workflow">30</a> depicts the concrete sequence of a reconciliation loop. An important note on admission webhooks (mutators/validators): if the operator does not respond within ten seconds, the API will abort the creation/modification/deletion of the resource. This could lead to deadlocks when the operator crashes or is not able to respond to the webhooks.</p>
<h3 id="what-is-an-operator-sdk">What is an Operator SDK?</h3>
<p>To help developers create custom operators, SDKs provide aid to perform the Kubernetes specific tasks. Depending on the SDK, several technical elements are abstracted like registering and error handling of the wachers. A non-exhaustive list of SDKs includes:</p>
<ul>
<li>KUDO<a href="#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup>35</sup></a>: A declarative operator SDK that creates operators based on declarative descriptions.</li>
<li>kubebuilder<a href="#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup>36</sup></a>: A GoLang based SDK that allows creating controllers and validation webhooks.</li>
<li>OPERATOR SDK<a href="#fn37" class="footnote-ref" id="fnref37" role="doc-noteref"><sup>37</sup></a>: A multi language SDK that allows GoLang based operators, Helm based operators, or Ansible based operators by using hooks to execute scripts.</li>
<li>Shell-operator<a href="#fn38" class="footnote-ref" id="fnref38" role="doc-noteref"><sup>38</sup></a>: Event driven script runner for Kubernetes. Operator SDK for shell scripts.</li>
<li>Kopf<a href="#fn39" class="footnote-ref" id="fnref39" role="doc-noteref"><sup>39</sup></a>: “Kubernetes Operator Framework (Kopf),” is a Python based SDK with an immense feature set.</li>
<li>KubeOps<a href="#fn40" class="footnote-ref" id="fnref40" role="doc-noteref"><sup>40</sup></a>: A .NET operator SDK based on the principles of ASP.NET applications. Operators can be created with C# or F#.</li>
</ul>
<h2 id="exercise-create-a-custom-operator-with-an-sdk">Exercise: Create a Custom Operator with an SDK</h2>
<h3 id="tldr">TL;DR</h3>
<ol type="1">
<li>Create an empty operator with an SDK of your choice and run it.</li>
<li>Create a CRD for a “WeatherLocation” and for “WeatherData.”</li>
<li>Create the controllers for the CRDs and run/deploy the operator. The use case is: The user can create a WeatherLocation object and the operator should then fetch any weather data API and create WeatherData objects for each hour. When a specific amount of WeatherData elements are created, old objects must be deleted.</li>
</ol>
<p>The examples and solutions are created with KubeOps in C#. When code is shown, the required “usings” are omitted. A possible solution can be found on GitHub: <a href="https://github.com/buehler/kubernetes-operator-exercise" class="uri">https://github.com/buehler/kubernetes-operator-exercise</a>.</p>
<h3 id="create-and-run-an-empty-operator">Create and Run an empty Operator</h3>
<p>Select an SDK and create an empty operator and run it against a Kubernetes environment. One can use any Kubernetes environments, but it is advised to use a local instance like Docker Desktop with Kubernetes or <a href="https://minikube.sigs.k8s.io/docs/start/">minikube</a>.</p>
<h4 id="solution">Solution</h4>
<p>KubeOps provides templates to create an operator.</p>
<ol type="1">
<li>Install the templates: <code>dotnet new -i KubeOps.Templates::*</code></li>
<li>Create the empty operator: <code>dotnet new operator-empty -n WeatherOperator -o ./weather-operator</code></li>
<li>Run the empty operator against the Kubernetes environment</li>
</ol>
<p>You should see the following log output:</p>
<pre><code>info: KubeOps.Operator.Leadership.LeaderElector[0]
      Startup Leader Elector for operator &quot;weatheroperator&quot;.
info: KubeOps.Operator.Leadership.LeaderElector[0]
      There was no lease for operator &quot;weatheroperator&quot;.
      Creating one and electing &quot;xxx&quot; as leader.
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: https://localhost:5001
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development</code></pre>
<p>The empty operator in C# only registers the operator logic with ASP.NET and starts the webserver. The minimal config required to run consists of:</p>
<p><code>Program.cs</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode csharp"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> IHostBuilder <span class="fu">CreateHostBuilder</span><span class="op">(</span><span class="dt">string</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    Host<span class="op">.</span><span class="fu">CreateDefaultBuilder</span><span class="op">(</span>args<span class="op">)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">ConfigureWebHostDefaults</span><span class="op">(</span>webBuilder <span class="op">=&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            webBuilder<span class="op">.</span><span class="fu">UseStartup</span><span class="op">&lt;</span>Startup<span class="op">&gt;();</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>await <span class="fu">CreateHostBuilder</span><span class="op">(</span>args<span class="op">).</span><span class="fu">Build</span><span class="op">().</span><span class="fu">RunOperatorAsync</span><span class="op">(</span>args<span class="op">);</span></span></code></pre></div>
<p><code>Startup.cs</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode csharp"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Startup</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ConfigureServices</span><span class="op">(</span>IServiceCollection services<span class="op">)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        services<span class="op">.</span><span class="fu">AddKubernetesOperator</span><span class="op">();</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Configure</span><span class="op">(</span>IApplicationBuilder app<span class="op">)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        app<span class="op">.</span><span class="fu">UseKubernetesOperator</span><span class="op">();</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="create-the-custom-resource-definition">Create the Custom Resource Definition</h3>
<p>Create the required objects in the operator and create the CRD for Kubernetes. The CRD is the element that gets installed in the API of Kubernetes. The following two objects must be created:</p>
<ul>
<li><strong>WeatherLocation</strong>: Object that contains the required data to query a weather API for weather data. As an example, if the <a href="https://openweathermap.org/api">OpenWeather API</a> is used, the object should include latitude and longitude to identify the point of interest. Depending on the API you intent to use, you may need to add other fields.</li>
<li><strong>WeatherData</strong>: This object shall not be created by a user. It contains the “result” for a weather query. It must be linked to a WeatherLocation and should be cleaned up after 24 hours.</li>
</ul>
<h4 id="solution-1">Solution</h4>
<p><code>WeatherLocation</code>: To use the OpenWeather API, we only need the latitude and the longitude to create a weather call.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode csharp"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> V1WeatherLocationSpec</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">double</span> Latitude <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">double</span> Longitude <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> V1WeatherLocationStatus</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DateTime<span class="op">?</span> LastCheck <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span><span class="op">?</span> Error <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">KubernetesEntity</span><span class="op">(</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    ApiVersion <span class="op">=</span> <span class="st">&quot;v1&quot;</span><span class="op">,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    Group <span class="op">=</span> <span class="st">&quot;kubernetes.dev&quot;</span><span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    Kind <span class="op">=</span> <span class="st">&quot;WeatherLocation&quot;</span><span class="op">)]</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> V1WeatherLocation <span class="op">:</span> CustomKubernetesEntity</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>V1WeatherLocationSpec<span class="op">,</span> V1WeatherLocationStatus<span class="op">&gt;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>WeatherData</code>: This object should be created by the operator during runtime. It contains several elements of the weather call. The weather data object must be linked to a weather location.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode csharp"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> V1WeatherDataSpec</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>AdditionalPrinterColumn<span class="op">]</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> MainWeather <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span> <span class="op">=</span> <span class="dt">string</span><span class="op">.</span><span class="fu">Empty</span><span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> Description <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span> <span class="op">=</span> <span class="dt">string</span><span class="op">.</span><span class="fu">Empty</span><span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>AdditionalPrinterColumn<span class="op">]</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">double</span> Temperature <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DateTime Sunrise <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DateTime Sunset <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">KubernetesEntity</span><span class="op">(</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    ApiVersion <span class="op">=</span> <span class="st">&quot;v1&quot;</span><span class="op">,</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    Group <span class="op">=</span> <span class="st">&quot;kubernetes.dev&quot;</span><span class="op">,</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    Kind <span class="op">=</span> <span class="st">&quot;WeatherData&quot;</span><span class="op">)]</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> V1WeatherData <span class="op">:</span> CustomKubernetesEntity<span class="op">&lt;</span>V1WeatherDataSpec<span class="op">&gt;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>KubeOps generates the following CRDs:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apiextensions.k8s.io/v1</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CustomResourceDefinition</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> weatherlocations.kubernetes.dev</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group</span><span class="kw">:</span><span class="at"> kubernetes.dev</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">names</span><span class="kw">:</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> WeatherLocation</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">listKind</span><span class="kw">:</span><span class="at"> WeatherLocationList</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">plural</span><span class="kw">:</span><span class="at"> weatherlocations</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">singular</span><span class="kw">:</span><span class="at"> weatherlocation</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scope</span><span class="kw">:</span><span class="at"> Namespaced</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">versions</span><span class="kw">:</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">openAPIV3Schema</span><span class="kw">:</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Status object for the entity.</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">lastCheck</span><span class="kw">:</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> date-time</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">nullable</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">error</span><span class="kw">:</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">nullable</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Specification of the kubernetes object.</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">latitude</span><span class="kw">:</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> double</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">longitude</span><span class="kw">:</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> double</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">served</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">subresources</span><span class="kw">:</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">status</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apiextensions.k8s.io/v1</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> CustomResourceDefinition</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> weatherdatas.kubernetes.dev</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group</span><span class="kw">:</span><span class="at"> kubernetes.dev</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">names</span><span class="kw">:</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">kind</span><span class="kw">:</span><span class="at"> WeatherData</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">listKind</span><span class="kw">:</span><span class="at"> WeatherDataList</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">plural</span><span class="kw">:</span><span class="at"> weatherdatas</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">singular</span><span class="kw">:</span><span class="at"> weatherdata</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">scope</span><span class="kw">:</span><span class="at"> Namespaced</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">versions</span><span class="kw">:</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">additionalPrinterColumns</span><span class="kw">:</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">jsonPath</span><span class="kw">:</span><span class="at"> .spec.mainWeather</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MainWeather</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">priority</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">format</span><span class="kw">:</span><span class="at"> double</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">jsonPath</span><span class="kw">:</span><span class="at"> .spec.temperature</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Temperature</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">priority</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">schema</span><span class="kw">:</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">openAPIV3Schema</span><span class="kw">:</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Specification of the kubernetes object.</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">mainWeather</span><span class="kw">:</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">temperature</span><span class="kw">:</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> double</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">sunrise</span><span class="kw">:</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> date-time</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">sunset</span><span class="kw">:</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">format</span><span class="kw">:</span><span class="at"> date-time</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="at">                  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">served</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">storage</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div>
<p>These CRDs may now be installed into Kubernetes with <code>kubectl apply</code>.</p>
<h3 id="reconcile-the-custom-resource">Reconcile the Custom Resource</h3>
<p>As the operator base and the CRDs are prepared, you are now to build the operator logic. The operator must fulfill the following requirements:</p>
<ul>
<li>A weather API call is executed each hour for a given weather location object</li>
<li>The result of the API call is stored in Kubernetes as weather data object and linked to the weather location (owner reference)</li>
<li>While reconciling, the operator deletes old weather data objects (keep the last twelfe)</li>
<li>A validator checks if the longitude and latitude values are possible and denies the creation of the object if they are not within the boundaries</li>
<li>A validator checks if a weather data object contains an owner reference</li>
</ul>
<h4 id="solution-2">Solution</h4>
<p>Since it is not feasible to print the whole source code in this exercise, please find a possible solution on GitHub: <a href="https://github.com/buehler/kubernetes-operator-exercise" class="uri">https://github.com/buehler/kubernetes-operator-exercise</a>.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>According to the matrix problem: <span class="math inline"><em>X</em> services * <em>Y</em> authentication methods</span><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><a href="https://kubernetes.io/" class="uri">https://kubernetes.io/</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p><a href="https://www.envoyproxy.io/" class="uri">https://www.envoyproxy.io/</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment" class="uri">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p><a href="https://www.getambassador.io/" class="uri">https://www.getambassador.io/</a><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p><a href="https://github.com/prometheus-operator/prometheus-operator" class="uri">https://github.com/prometheus-operator/prometheus-operator</a><a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p><a href="https://github.com/zalando/postgres-operator" class="uri">https://github.com/zalando/postgres-operator</a><a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p><a href="https://github.com/GoogleCloudPlatform/cloudsql-proxy" class="uri">https://github.com/GoogleCloudPlatform/cloudsql-proxy</a><a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>As done by Istio (<a href="https://istio.io/latest/docs/reference/config/networking/sidecar/" class="uri">https://istio.io/latest/docs/reference/config/networking/sidecar/</a>)<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10" role="doc-endnote"><p>Like the Google CloudSQL Proxy<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11" role="doc-endnote"><p><a href="https://istio.io/" class="uri">https://istio.io/</a><a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12" role="doc-endnote"><p><a href="https://grpc.io/" class="uri">https://grpc.io/</a><a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13" role="doc-endnote"><p><a href="https://www.nginx.com/" class="uri">https://www.nginx.com/</a><a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14" role="doc-endnote"><p><a href="https://www.vaultproject.io/" class="uri">https://www.vaultproject.io/</a><a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15" role="doc-endnote"><p><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter" class="uri">https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter</a><a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16" role="doc-endnote"><p>Access token of an IDP.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17" role="doc-endnote"><p><a href="https://github.com/buehler/dotnet-operator-sdk" class="uri">https://github.com/buehler/dotnet-operator-sdk</a><a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18" role="doc-endnote"><p><a href="https://zitadel.ch" class="uri">https://zitadel.ch</a><a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19" role="doc-endnote"><p><a href="https://docs.docker.com/desktop/kubernetes/" class="uri">https://docs.docker.com/desktop/kubernetes/</a><a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn20" role="doc-endnote"><p><a href="https://minikube.sigs.k8s.io/docs/start/" class="uri">https://minikube.sigs.k8s.io/docs/start/</a><a href="#fnref20" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn21" role="doc-endnote"><p><a href="https://kustomize.io/" class="uri">https://kustomize.io/</a><a href="#fnref21" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn22" role="doc-endnote"><p>In the example, it is “https://kubernetes.docker.internal” since this is the local configured default URL for “Docker Desktop”<a href="#fnref22" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn23" role="doc-endnote"><p><a href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages/" class="uri">https://docs.microsoft.com/en-us/aspnet/core/razor-pages/</a><a href="#fnref23" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn24" role="doc-endnote"><p>Binary Data Format by Google: <a href="https://developers.google.com/protocol-buffers" class="uri">https://developers.google.com/protocol-buffers</a><a href="#fnref24" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn25" role="doc-endnote"><p>Broken Authentication relates to incorrectly implemented authentication and session management. This would allow attackers to compromise sessions and passwords.<a href="#fnref25" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn26" role="doc-endnote"><p><a href="https://github.com/prometheus-operator/prometheus-operator" class="uri">https://github.com/prometheus-operator/prometheus-operator</a><a href="#fnref26" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn27" role="doc-endnote"><p><a href="https://prometheus.io/" class="uri">https://prometheus.io/</a><a href="#fnref27" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn28" role="doc-endnote"><p><a href="https://github.com/buehler/dotnet-operator-sdk" class="uri">https://github.com/buehler/dotnet-operator-sdk</a><a href="#fnref28" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn29" role="doc-endnote"><p><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes" class="uri">https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes</a><a href="#fnref29" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn30" role="doc-endnote"><p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" class="uri">https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/</a><a href="#fnref30" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn31" role="doc-endnote"><p><a href="https://kubernetes.io/docs/concepts/architecture/controller/" class="uri">https://kubernetes.io/docs/concepts/architecture/controller/</a><a href="#fnref31" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn32" role="doc-endnote"><p><a href="https://kubernetes.io/blog/2021/05/14/using-finalizers-to-control-deletion/" class="uri">https://kubernetes.io/blog/2021/05/14/using-finalizers-to-control-deletion/</a><a href="#fnref32" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn33" role="doc-endnote"><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" class="uri">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/</a><a href="#fnref33" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn34" role="doc-endnote"><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" class="uri">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/</a><a href="#fnref34" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn35" role="doc-endnote"><p><a href="https://kudo.dev/" class="uri">https://kudo.dev/</a><a href="#fnref35" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn36" role="doc-endnote"><p><a href="https://book.kubebuilder.io/" class="uri">https://book.kubebuilder.io/</a><a href="#fnref36" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn37" role="doc-endnote"><p><a href="https://operatorframework.io/" class="uri">https://operatorframework.io/</a><a href="#fnref37" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn38" role="doc-endnote"><p><a href="https://github.com/flant/shell-operator" class="uri">https://github.com/flant/shell-operator</a><a href="#fnref38" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn39" role="doc-endnote"><p><a href="https://kopf.readthedocs.io/en/stable/" class="uri">https://kopf.readthedocs.io/en/stable/</a><a href="#fnref39" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn40" role="doc-endnote"><p><a href="https://buehler.github.io/dotnet-operator-sdk/" class="uri">https://buehler.github.io/dotnet-operator-sdk/</a><a href="#fnref40" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
